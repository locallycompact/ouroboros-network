<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts     #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GADTs                #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase           #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf           #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns       #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE PatternSynonyms      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards      #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables  #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving   #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications     #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-comment">-- | Operations involving chain selection: the initial chain selection and</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- adding a block.</span><span>
</span><span id="line-15"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockAsync"><span class="hs-identifier">addBlockAsync</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockSync"><span class="hs-identifier">addBlockSync</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock"><span class="hs-identifier">chainSelectionForBlock</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#initialChainSelection"><span class="hs-identifier">initialChainSelection</span></a></span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Exported for testing purposes</span></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK"><span class="hs-identifier">olderThanK</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/mtl-2.2.2/src"><span class="hs-identifier">Control.Monad.Except</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier">Control.Monad.Trans.State.Strict</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Function</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">on</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">partition</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">sortBy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">NonEmpty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">isJust</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Anchor</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">AnchoredFragment</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>                     </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">AnchoredSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AF</span></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Config.html"><span class="hs-identifier">Ouroboros.Consensus.Config</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.InFuture.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.InFuture</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.InFuture.html#CheckInFuture"><span class="hs-identifier">CheckInFuture</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.InFuture.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.InFuture</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InFuture</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier">ValidatedFragment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.Validated</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VF</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.HardFork.Abstract</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.History.html"><span class="hs-identifier">Ouroboros.Consensus.HardFork.History</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">History</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Inspect</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsProtocol</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.AnchoredFragment.html"><span class="hs-identifier">Ouroboros.Consensus.Util.AnchoredFragment</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html"><span class="hs-identifier">Ouroboros.Consensus.Util.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.Diff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.Diff</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Diff</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.ValidatedDiff</span></a></span><span>
</span><span id="line-62"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.ValidatedDiff</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ValidatedDiff</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#AddBlockPromise"><span class="hs-identifier">AddBlockPromise</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier">BlockComponent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier">InvalidBlockReason</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache</span></a></span><span>
</span><span id="line-67"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#BlockCache"><span class="hs-identifier">BlockCache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BlockCache</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier">LedgerDB'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDB"><span class="hs-identifier">LgrDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LgrDB</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Paths</span></a></span><span>
</span><span id="line-73"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#LookupBlockInfo"><span class="hs-identifier">LookupBlockInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Paths</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Paths</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Query</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Query</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Types</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#ImmutableDB"><span class="hs-identifier">ImmutableDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ImmutableDB</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#VolatileDB"><span class="hs-identifier">VolatileDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VolatileDB</span></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- | Perform the initial chain selection based on the tip of the ImmutableDB</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- and the contents of the VolatileDB.</span><span>
</span><span id="line-84"></span><span class="hs-comment">--</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- Returns the chosen validated chain and corresponding ledger.</span><span>
</span><span id="line-86"></span><span class="hs-comment">--</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- See &quot;## Initialization&quot; in ChainDB.md.</span><span>
</span><span id="line-88"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#initialChainSelection"><span class="hs-identifier hs-type">initialChainSelection</span></a></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680026307"><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680026306"><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#ImmutableDB"><span class="hs-identifier hs-type">ImmutableDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#VolatileDB"><span class="hs-identifier hs-type">VolatileDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDB"><span class="hs-identifier hs-type">LgrDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceInitChainSelEvent"><span class="hs-identifier hs-type">TraceInitChainSelEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.html#TopLevelConfig"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlocks"><span class="hs-identifier hs-type">InvalidBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#FutureBlocks"><span class="hs-identifier hs-type">FutureBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.InFuture.html#CheckInFuture"><span class="hs-identifier hs-type">CheckInFuture</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span id="initialChainSelection"><span class="annot"><span class="annottext">initialChainSelection :: ImmutableDB m blk
-&gt; VolatileDB m blk
-&gt; LgrDB m blk
-&gt; Tracer m (TraceInitChainSelEvent blk)
-&gt; TopLevelConfig blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; StrictTVar m (FutureBlocks blk)
-&gt; CheckInFuture m blk
-&gt; m (ChainAndLedger blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#initialChainSelection"><span class="hs-identifier hs-var hs-var">initialChainSelection</span></a></span></span><span> </span><span id="local-6989586621680026305"><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621680026305"><span class="hs-identifier hs-var">immutableDB</span></a></span></span><span> </span><span id="local-6989586621680026304"><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680026304"><span class="hs-identifier hs-var">volatileDB</span></a></span></span><span> </span><span id="local-6989586621680026303"><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680026303"><span class="hs-identifier hs-var">lgrDB</span></a></span></span><span> </span><span id="local-6989586621680026302"><span class="annot"><span class="annottext">Tracer m (TraceInitChainSelEvent blk)
</span><a href="#local-6989586621680026302"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680026301"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680026301"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621680026300"><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680026300"><span class="hs-identifier hs-var">varInvalid</span></a></span></span><span>
</span><span id="line-100"></span><span>                      </span><span id="local-6989586621680026299"><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks blk)
</span><a href="#local-6989586621680026299"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span></span><span> </span><span id="local-6989586621680026298"><span class="annot"><span class="annottext">CheckInFuture m blk
</span><a href="#local-6989586621680026298"><span class="hs-identifier hs-var">futureCheck</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- We follow the steps from section &quot;## Initialization&quot; in ChainDB.md</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680026297"><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621680026297"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Anchor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026296"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026296"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026295"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680026295"><span class="hs-identifier hs-var">ledger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk), LedgerDB' blk)
-&gt; m (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
      LedgerDB' blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk), LedgerDB' blk)
 -&gt; m (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
       LedgerDB' blk))
-&gt; STM
     m
     (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk), LedgerDB' blk)
-&gt; m (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
      LedgerDB' blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-104"></span><span>      </span><span id="local-6989586621680026293"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680026293"><span class="hs-identifier hs-var">invalid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var hs-var">forgetFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk)
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (InvalidBlocks blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680026300"><span class="hs-identifier hs-var">varInvalid</span></a></span><span>
</span><span id="line-105"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>        </span><span class="annot"><span class="annottext">(Anchor blk
 -&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
 -&gt; LedgerDB' blk
 -&gt; (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
     LedgerDB' blk))
-&gt; STM m (Anchor blk)
-&gt; STM
     m
     ((ChainHash blk -&gt; Set (HeaderHash blk))
      -&gt; LedgerDB' blk
      -&gt; (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
          LedgerDB' blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk -&gt; STM m (Anchor blk)
forall (m :: * -&gt; *) blk.
(MonadSTM m, HasCallStack) =&gt;
ImmutableDB m blk -&gt; STM m (Anchor blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#getTipAnchor"><span class="hs-identifier hs-var">ImmutableDB.getTipAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621680026305"><span class="hs-identifier hs-var">immutableDB</span></a></span><span>
</span><span id="line-107"></span><span>        </span><span class="annot"><span class="annottext">STM
  m
  ((ChainHash blk -&gt; Set (HeaderHash blk))
   -&gt; LedgerDB' blk
   -&gt; (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
       LedgerDB' blk))
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; STM
     m
     (LedgerDB' blk
      -&gt; (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
          LedgerDB' blk))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; InvalidBlocks blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
forall blk (proxy :: * -&gt; *).
HasHeader blk =&gt;
proxy blk
-&gt; InvalidBlocks blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalidSuc"><span class="hs-identifier hs-var">ignoreInvalidSuc</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680026304"><span class="hs-identifier hs-var">volatileDB</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680026293"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="annot"><span class="annottext">((ChainHash blk -&gt; Set (HeaderHash blk))
 -&gt; ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-108"></span><span>              </span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
forall (m :: * -&gt; *) blk.
VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#filterByPredecessor"><span class="hs-identifier hs-var hs-var">VolatileDB.filterByPredecessor</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680026304"><span class="hs-identifier hs-var">volatileDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>        </span><span class="annot"><span class="annottext">STM
  m
  (LedgerDB' blk
   -&gt; (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
       LedgerDB' blk))
-&gt; STM m (LedgerDB' blk)
-&gt; STM
     m
     (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk), LedgerDB' blk)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; STM m (LedgerDB' blk)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
LgrDB m blk -&gt; STM m (LedgerDB' blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#getCurrent"><span class="hs-identifier hs-var">LgrDB.getCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680026303"><span class="hs-identifier hs-var">lgrDB</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>    </span><span id="local-6989586621680026285"><span class="annot"><span class="annottext">[AnchoredFragment (Header blk)]
</span><a href="#local-6989586621680026285"><span class="hs-identifier hs-var">chains</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Anchor blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; m [AnchoredFragment (Header blk)]
</span><a href="#local-6989586621680026284"><span class="hs-identifier hs-var">constructChains</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621680026297"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026296"><span class="hs-identifier hs-var">succsOf</span></a></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-comment">-- We use the empty fragment anchored at @i@ as the current chain (and</span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-comment">-- ledger) and the default in case there is no better candidate.</span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680026283"><span class="annot"><span class="annottext">curChain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026283"><span class="hs-identifier hs-var hs-var">curChain</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk) -&gt; AnchoredFragment (Header blk)
forall v a b. Anchorable v a b =&gt; a -&gt; AnchoredSeq v a b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">Empty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Anchor blk -&gt; Anchor (Header blk)
forall a b. (HeaderHash a ~ HeaderHash b) =&gt; Anchor a -&gt; Anchor b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.castAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621680026297"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>        </span><span id="local-6989586621680026280"><span class="annot"><span class="annottext">curChainAndLedger :: ChainAndLedger blk
</span><a href="#local-6989586621680026280"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; LedgerDB' blk -&gt; ChainAndLedger blk
forall l b.
(IsLedger l, HasHeader b, HeaderHash b ~ HeaderHash l,
 HasCallStack) =&gt;
AnchoredFragment b -&gt; l -&gt; ValidatedFragment b l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier hs-var">VF.ValidatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026283"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680026295"><span class="hs-identifier hs-var">ledger</span></a></span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment (Header blk)]
-&gt; Maybe (NonEmpty (AnchoredFragment (Header blk)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; [AnchoredFragment (Header blk)]
-&gt; [AnchoredFragment (Header blk)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621680026276"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026283"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment (Header blk)]
</span><a href="#local-6989586621680026285"><span class="hs-identifier hs-var">chains</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-comment">-- If there are no candidates, no chain selection is needed</span><span>
</span><span id="line-120"></span><span>      </span><span class="annot"><span class="annottext">Maybe (NonEmpty (AnchoredFragment (Header blk)))
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; m (ChainAndLedger blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026280"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-121"></span><span>      </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680026275"><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026275"><span class="hs-identifier hs-var">chains'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
-&gt; (ValidatedChainDiff (Header blk) (LedgerDB' blk)
    -&gt; ChainAndLedger blk)
-&gt; Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; ChainAndLedger blk
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026280"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ChainAndLedger blk
</span><a href="#local-6989586621680026273"><span class="hs-identifier hs-var">toChainAndLedger</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
 -&gt; ChainAndLedger blk)
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (ChainAndLedger blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-122"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
ChainAndLedger blk
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
ChainAndLedger blk
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621680026272"><span class="hs-identifier hs-var">chainSelection'</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026280"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026275"><span class="hs-identifier hs-var">chains'</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="#local-6989586621680026276"><span class="hs-identifier hs-type">bcfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockConfig"><span class="hs-identifier hs-type">BlockConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621680026276"><span class="annot"><span class="annottext">bcfg :: BlockConfig blk
</span><a href="#local-6989586621680026276"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; BlockConfig blk
forall blk. TopLevelConfig blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configBlock"><span class="hs-identifier hs-var">configBlock</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680026301"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-comment">-- | Turn the 'ValidatedChainDiff' into a 'ChainAndLedger'.</span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-comment">-- The rollback of the 'ChainDiff' must be empty, as the suffix starts</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-comment">-- from the tip of the ImmutableDB, and we can't roll back past that tip.</span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-comment">-- This is guaranteed by the fact that all constructed candidates start</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-comment">-- from this tip.</span><span>
</span><span id="line-133"></span><span>    </span><span class="annot"><a href="#local-6989586621680026273"><span class="hs-identifier hs-type">toChainAndLedger</span></a></span><span>
</span><span id="line-134"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span id="local-6989586621680026273"><span class="annot"><span class="annottext">toChainAndLedger :: ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ChainAndLedger blk
</span><a href="#local-6989586621680026273"><span class="hs-identifier hs-var hs-var">toChainAndLedger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span id="local-6989586621680026269"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680026269"><span class="hs-identifier hs-var">chainDiff</span></a></span></span><span> </span><span id="local-6989586621680026268"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680026268"><span class="hs-identifier hs-var">ledger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-137"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680026269"><span class="hs-identifier hs-var">chainDiff</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-138"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span id="local-6989586621680026266"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680026266"><span class="hs-identifier hs-var">rollback</span></a></span></span><span> </span><span id="local-6989586621680026265"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026265"><span class="hs-identifier hs-var">suffix</span></a></span></span><span>
</span><span id="line-139"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680026266"><span class="hs-identifier hs-var">rollback</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-140"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; LedgerDB' blk -&gt; ChainAndLedger blk
forall l b.
(IsLedger l, HasHeader b, HeaderHash b ~ HeaderHash l,
 HasCallStack) =&gt;
AnchoredFragment b -&gt; l -&gt; ValidatedFragment b l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier hs-var">VF.ValidatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026265"><span class="hs-identifier hs-var">suffix</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680026268"><span class="hs-identifier hs-var">ledger</span></a></span><span>
</span><span id="line-141"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-142"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ChainAndLedger blk
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;constructed an initial chain with rollback&quot;</span></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- | Use the VolatileDB to construct all chains starting from the tip of</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-comment">-- the ImmutableDB.</span><span>
</span><span id="line-146"></span><span>    </span><span class="annot"><a href="#local-6989586621680026284"><span class="hs-identifier hs-type">constructChains</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-147"></span><span>         </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Anchor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-comment">-- ^ Tip of the ImmutableDB, @i@</span><span>
</span><span id="line-148"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621680026284"><span class="annot"><span class="annottext">constructChains :: Anchor blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; m [AnchoredFragment (Header blk)]
</span><a href="#local-6989586621680026284"><span class="hs-identifier hs-var hs-var">constructChains</span></a></span></span><span> </span><span id="local-6989586621680026263"><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621680026263"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621680026262"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026262"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StateT (FutureBlocks blk) m [AnchoredFragment (Header blk)]
 -&gt; FutureBlocks blk -&gt; m [AnchoredFragment (Header blk)])
-&gt; FutureBlocks blk
-&gt; StateT (FutureBlocks blk) m [AnchoredFragment (Header blk)]
-&gt; m [AnchoredFragment (Header blk)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">StateT (FutureBlocks blk) m [AnchoredFragment (Header blk)]
-&gt; FutureBlocks blk -&gt; m [AnchoredFragment (Header blk)]
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">evalStateT</span></a></span><span> </span><span class="annot"><span class="annottext">FutureBlocks blk
forall k a. Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT (FutureBlocks blk) m [AnchoredFragment (Header blk)]
 -&gt; m [AnchoredFragment (Header blk)])
-&gt; StateT (FutureBlocks blk) m [AnchoredFragment (Header blk)]
-&gt; m [AnchoredFragment (Header blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-151"></span><span>        </span><span class="annot"><span class="annottext">(NonEmpty (HeaderHash blk)
 -&gt; StateT (FutureBlocks blk) m (AnchoredFragment (Header blk)))
-&gt; [NonEmpty (HeaderHash blk)]
-&gt; StateT (FutureBlocks blk) m [AnchoredFragment (Header blk)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
-&gt; StateT (FutureBlocks blk) m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026257"><span class="hs-identifier hs-var">constructChain</span></a></span><span> </span><span class="annot"><span class="annottext">[NonEmpty (HeaderHash blk)]
</span><a href="#local-6989586621680026256"><span class="hs-identifier hs-var">suffixesAfterI</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-153"></span><span>        </span><span class="annot"><a href="#local-6989586621680026256"><span class="hs-identifier hs-type">suffixesAfterI</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-154"></span><span>        </span><span id="local-6989586621680026256"><span class="annot"><span class="annottext">suffixesAfterI :: [NonEmpty (HeaderHash blk)]
</span><a href="#local-6989586621680026256"><span class="hs-identifier hs-var hs-var">suffixesAfterI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; Point blk -&gt; [NonEmpty (HeaderHash blk)]
forall blk.
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; Point blk -&gt; [NonEmpty (HeaderHash blk)]
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#maximalCandidates"><span class="hs-identifier hs-var">Paths.maximalCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026262"><span class="hs-identifier hs-var">succsOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Anchor blk -&gt; Point blk
forall block. Anchor block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.anchorToPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621680026263"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>        </span><span class="annot"><a href="#local-6989586621680026257"><span class="hs-identifier hs-type">constructChain</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-157"></span><span>             </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-type">StateT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>                    </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-160"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>        </span><span id="local-6989586621680026257"><span class="annot"><span class="annottext">constructChain :: NonEmpty (HeaderHash blk)
-&gt; StateT (FutureBlocks blk) m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026257"><span class="hs-identifier hs-var hs-var">constructChain</span></a></span></span><span> </span><span id="local-6989586621680026253"><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
</span><a href="#local-6989586621680026253"><span class="hs-identifier hs-var">hashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-162"></span><span>            </span><span class="annot"><span class="annottext">Anchor (Header blk)
-&gt; [Header blk] -&gt; AnchoredFragment (Header blk)
forall v a b. Anchorable v a b =&gt; a -&gt; [b] -&gt; AnchoredSeq v a b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.fromOldestFirst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Anchor blk -&gt; Anchor (Header blk)
forall a b. (HeaderHash a ~ HeaderHash b) =&gt; Anchor a -&gt; Anchor b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.castAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621680026263"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Header blk] -&gt; AnchoredFragment (Header blk))
-&gt; StateT (FutureBlocks blk) m [Header blk]
-&gt; StateT (FutureBlocks blk) m (AnchoredFragment (Header blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-163"></span><span>            </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; StateT (FutureBlocks blk) m (Header blk))
-&gt; [HeaderHash blk] -&gt; StateT (FutureBlocks blk) m [Header blk]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HeaderHash blk -&gt; StateT (FutureBlocks blk) m (Header blk)
forall (m :: * -&gt; *) blk.
(MonadThrow m, HasHeader blk) =&gt;
VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getKnownHeaderThroughCache"><span class="hs-identifier hs-var">getKnownHeaderThroughCache</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680026304"><span class="hs-identifier hs-var">volatileDB</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk) -&gt; [HeaderHash blk]
forall a. NonEmpty a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
</span><a href="#local-6989586621680026253"><span class="hs-identifier hs-var">hashes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-comment">-- | Perform chain selection (including validation) on the given</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- candidates.</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-comment">-- PRECONDITION: all candidates are anchored at @i@.</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-comment">-- PRECONDITION: all candidates must be preferred over the current chain.</span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><a href="#local-6989586621680026272"><span class="hs-identifier hs-type">chainSelection'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-172"></span><span>         </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-173"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-174"></span><span>         </span><span class="hs-comment">-- ^ The current chain and ledger, corresponding to</span><span>
</span><span id="line-175"></span><span>         </span><span class="hs-comment">-- @i@.</span><span>
</span><span id="line-176"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>         </span><span class="hs-comment">-- ^ Candidates anchored at @i@</span><span>
</span><span id="line-178"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>    </span><span id="local-6989586621680026272"><span class="annot"><span class="annottext">chainSelection' :: ChainAndLedger blk
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621680026272"><span class="hs-identifier hs-var hs-var">chainSelection'</span></a></span></span><span> </span><span id="local-6989586621680026249"><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026249"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span></span><span> </span><span id="local-6989586621680026248"><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026248"><span class="hs-identifier hs-var">candidates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; NonEmpty (AnchoredFragment (Header blk)) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; Point blk
forall blk. UpdateLedger blk =&gt; LedgerDB' blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#currentPoint"><span class="hs-identifier hs-var">LgrDB.currentPoint</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680026245"><span class="hs-identifier hs-var">ledger</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Point blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk -&gt; Bool)
-&gt; (AnchoredFragment (Header blk) -&gt; Point blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span>
</span><span id="line-181"></span><span>                     </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; (AnchoredFragment (Header blk) -&gt; Point (Header blk))
-&gt; AnchoredFragment (Header blk)
-&gt; Point blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.anchorPoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>                    </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026248"><span class="hs-identifier hs-var">candidates</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-183"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; NonEmpty (AnchoredFragment (Header blk)) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621680026276"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026241"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026248"><span class="hs-identifier hs-var">candidates</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-184"></span><span>        </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelection"><span class="hs-identifier hs-var">chainSelection</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680026239"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; ChainDiff (Header blk)
forall b. AnchoredFragment b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#extend"><span class="hs-identifier hs-var">Diff.extend</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; ChainDiff (Header blk))
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; NonEmpty (ChainDiff (Header blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026248"><span class="hs-identifier hs-var">candidates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-186"></span><span>        </span><span id="local-6989586621680026241"><span class="annot"><span class="annottext">curChain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026241"><span class="hs-identifier hs-var hs-var">curChain</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; AnchoredFragment (Header blk)
forall b l. ValidatedFragment b l -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedFragment"><span class="hs-identifier hs-var hs-var">VF.validatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026249"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-187"></span><span>        </span><span id="local-6989586621680026245"><span class="annot"><span class="annottext">ledger :: LedgerDB' blk
</span><a href="#local-6989586621680026245"><span class="hs-identifier hs-var hs-var">ledger</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; LedgerDB' blk
forall b l. ValidatedFragment b l -&gt; l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedLedger"><span class="hs-identifier hs-var hs-var">VF.validatedLedger</span></a></span><span>   </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026249"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-188"></span><span>        </span><span id="local-6989586621680026239"><span class="annot"><span class="annottext">chainSelEnv :: ChainSelEnv m blk
</span><a href="#local-6989586621680026239"><span class="hs-identifier hs-var hs-var">chainSelEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainSelEnv :: forall (m :: * -&gt; *) blk.
LgrDB m blk
-&gt; (TraceValidationEvent blk -&gt; m ())
-&gt; BlockConfig blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; StrictTVar m (FutureBlocks blk)
-&gt; CheckInFuture m blk
-&gt; BlockCache blk
-&gt; ChainAndLedger blk
-&gt; ChainSelEnv m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span>
</span><span id="line-189"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
lgrDB :: LgrDB m blk
lgrDB :: LgrDB m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#lgrDB"><span class="hs-identifier hs-var hs-var">lgrDB</span></a></span><span>
</span><span id="line-190"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
bcfg :: BlockConfig blk
bcfg :: BlockConfig blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#bcfg"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span><span>
</span><span id="line-191"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varInvalid"><span class="hs-identifier hs-var hs-var">varInvalid</span></a></span><span>
</span><span id="line-192"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks blk)
varFutureBlocks :: StrictTVar m (FutureBlocks blk)
varFutureBlocks :: StrictTVar m (FutureBlocks blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varFutureBlocks"><span class="hs-identifier hs-var hs-var">varFutureBlocks</span></a></span><span>
</span><span id="line-193"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CheckInFuture m blk
futureCheck :: CheckInFuture m blk
futureCheck :: CheckInFuture m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheck"><span class="hs-identifier hs-var hs-var">futureCheck</span></a></span><span>
</span><span id="line-194"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blockCache :: BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#blockCache"><span class="hs-identifier hs-var">blockCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockCache blk
forall blk. BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#empty"><span class="hs-identifier hs-var">BlockCache.empty</span></a></span><span>
</span><span id="line-195"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
curChainAndLedger :: ChainAndLedger blk
curChainAndLedger :: ChainAndLedger blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#curChainAndLedger"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-196"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">trace :: TraceValidationEvent blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#trace"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
-&gt; TraceValidationEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span>
</span><span id="line-197"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceValidationEvent blk -&gt; TraceInitChainSelEvent blk)
-&gt; Tracer m (TraceInitChainSelEvent blk)
-&gt; Tracer m (TraceValidationEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; TraceInitChainSelEvent blk
forall blk. TraceValidationEvent blk -&gt; TraceInitChainSelEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InitChainSelValidation"><span class="hs-identifier hs-var">InitChainSelValidation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceInitChainSelEvent blk)
</span><a href="#local-6989586621680026302"><span class="hs-identifier hs-var">tracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-comment">-- | Add a block to the ChainDB, /asynchronously/.</span><span>
</span><span id="line-201"></span><span class="hs-comment">--</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- This adds a 'BlockToAdd' corresponding to the given block to the</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- 'cdbBlocksToAdd' queue. The entries in that queue are processed using</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- 'addBlockSync', see that function for more information.</span><span>
</span><span id="line-205"></span><span class="hs-comment">--</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- When the queue is full, this function will still block.</span><span>
</span><span id="line-207"></span><span class="hs-comment">--</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- An important advantage of this asynchronous approach over a synchronous</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- approach is that it doesn't have the following disadvantage: when a thread</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- adding a block to the ChainDB is killed, which can happen when</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- disconnecting from the corresponding node, we might have written the block</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- to disk, but not updated the corresponding in-memory state (e.g., that of</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- the VolatileDB), leaving both out of sync.</span><span>
</span><span id="line-214"></span><span class="hs-comment">--</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- With this asynchronous approach, threads adding blocks asynchronously can</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- be killed without worries, the background thread processing the blocks</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- synchronously won't be killed. Only when the whole ChainDB shuts down will</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- that background thread get killed. But since there will be no more</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- in-memory state, it can't get out of sync with the file system state. On</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- the next startup, a correct in-memory state will be reconstructed from the</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- file system state.</span><span>
</span><span id="line-222"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockAsync"><span class="hs-identifier hs-type">addBlockAsync</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680026224"><span class="annot"><a href="#local-6989586621680026224"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680026223"><span class="annot"><a href="#local-6989586621680026223"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026224"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026223"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026224"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026223"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026223"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026224"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#AddBlockPromise"><span class="hs-identifier hs-type">AddBlockPromise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026224"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026223"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span id="addBlockAsync"><span class="annot"><span class="annottext">addBlockAsync :: ChainDbEnv m blk -&gt; blk -&gt; m (AddBlockPromise m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockAsync"><span class="hs-identifier hs-var hs-var">addBlockAsync</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680026221"><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbTracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbTracer"><span class="hs-identifier hs-var hs-var">cdbTracer</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026219"><span class="annot"><span class="annottext">BlocksToAdd m blk
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbBlocksToAdd :: BlocksToAdd m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbBlocksToAdd"><span class="hs-identifier hs-var hs-var">cdbBlocksToAdd</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
-&gt; BlocksToAdd m blk -&gt; blk -&gt; m (AddBlockPromise m blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
Tracer m (TraceAddBlockEvent blk)
-&gt; BlocksToAdd m blk -&gt; blk -&gt; m (AddBlockPromise m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#addBlockToAdd"><span class="hs-identifier hs-var">addBlockToAdd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceAddBlockEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621680026221"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlocksToAdd m blk
</span><a href="#local-6989586621680026219"><span class="hs-identifier hs-var">cdbBlocksToAdd</span></a></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="hs-comment">-- | Add a block to the ChainDB, /synchronously/.</span><span>
</span><span id="line-231"></span><span class="hs-comment">--</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- This is the only operation that actually changes the ChainDB. It will store</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- the block on disk and trigger chain selection, possibly switching to a</span><span>
</span><span id="line-234"></span><span class="hs-comment">-- fork.</span><span>
</span><span id="line-235"></span><span class="hs-comment">--</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- When the slot of the block is &gt; the current slot, a chain selection will be</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- scheduled in the slot of the block.</span><span>
</span><span id="line-238"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockSync"><span class="hs-identifier hs-type">addBlockSync</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680026215"><span class="annot"><a href="#local-6989586621680026215"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680026214"><span class="annot"><a href="#local-6989586621680026214"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-240"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026215"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-241"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026214"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-242"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026214"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-243"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026214"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-244"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026214"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-245"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-246"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026215"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026214"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#BlockToAdd"><span class="hs-identifier hs-type">BlockToAdd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026215"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026214"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026215"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span id="addBlockSync"><span class="annot"><span class="annottext">addBlockSync :: ChainDbEnv m blk -&gt; BlockToAdd m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockSync"><span class="hs-identifier hs-var hs-var">addBlockSync</span></a></span></span><span> </span><span id="local-6989586621680026213"><span class="annot"><span class="annottext">cdb :: ChainDbEnv m blk
</span><a href="#local-6989586621680026213"><span class="hs-identifier hs-var">cdb</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680026191"><span id="local-6989586621680026192"><span id="local-6989586621680026193"><span id="local-6989586621680026194"><span id="local-6989586621680026195"><span id="local-6989586621680026196"><span id="local-6989586621680026197"><span id="local-6989586621680026198"><span id="local-6989586621680026199"><span id="local-6989586621680026200"><span id="local-6989586621680026201"><span id="local-6989586621680026202"><span id="local-6989586621680026203"><span id="local-6989586621680026204"><span id="local-6989586621680026205"><span id="local-6989586621680026206"><span id="local-6989586621680026207"><span id="local-6989586621680026208"><span id="local-6989586621680026209"><span id="local-6989586621680026210"><span id="local-6989586621680026211"><span id="local-6989586621680026212"><span class="annot"><span class="annottext">DiffTime
StrictTVar m (m ())
StrictTVar m (FutureBlocks blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
cdbFutureBlocks :: StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: BlocksToAdd m blk
cdbCheckInFuture :: CheckInFuture m blk
cdbCheckIntegrity :: blk -&gt; Bool
cdbChunkInfo :: ChunkInfo
cdbKillBgThreads :: StrictTVar m (m ())
cdbGcInterval :: DiffTime
cdbGcDelay :: DiffTime
cdbRegistry :: ResourceRegistry m
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbTracer :: Tracer m (TraceEvent blk)
cdbCopyLock :: StrictMVar m ()
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: LgrDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbImmutableDB :: ImmutableDB m blk
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbFutureBlocks"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#BlockToAdd"><span class="hs-identifier hs-type">BlockToAdd</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">blockToAdd :: forall (m :: * -&gt; *) blk. BlockToAdd m blk -&gt; blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#blockToAdd"><span class="hs-identifier hs-var">blockToAdd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621680026168"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026166"><span id="local-6989586621680026167"><span class="annot"><span class="annottext">StrictTMVar m Bool
StrictTMVar m (Point blk)
varBlockProcessed :: forall (m :: * -&gt; *) blk.
BlockToAdd m blk -&gt; StrictTMVar m (Point blk)
varBlockWrittenToDisk :: forall (m :: * -&gt; *) blk. BlockToAdd m blk -&gt; StrictTMVar m Bool
varBlockProcessed :: StrictTMVar m (Point blk)
varBlockWrittenToDisk :: StrictTMVar m Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#varBlockProcessed"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680026163"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Bool
</span><a href="#local-6989586621680026163"><span class="hs-identifier hs-var">isMember</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026162"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680026162"><span class="hs-identifier hs-var">invalid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026161"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026161"><span class="hs-identifier hs-var">curChain</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
   AnchoredFragment (Header blk))
-&gt; m (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
      AnchoredFragment (Header blk))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
    AnchoredFragment (Header blk))
 -&gt; m (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
       AnchoredFragment (Header blk)))
-&gt; STM
     m
     (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
      AnchoredFragment (Header blk))
-&gt; m (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
      AnchoredFragment (Header blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>      </span><span class="annot"><span class="annottext">((HeaderHash blk -&gt; Bool)
 -&gt; InvalidBlocks blk
 -&gt; AnchoredFragment (Header blk)
 -&gt; (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
     AnchoredFragment (Header blk)))
-&gt; STM m (HeaderHash blk -&gt; Bool)
-&gt; STM
     m
     (InvalidBlocks blk
      -&gt; AnchoredFragment (Header blk)
      -&gt; (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
          AnchoredFragment (Header blk)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk -&gt; STM m (HeaderHash blk -&gt; Bool)
forall (m :: * -&gt; *) blk.
Functor (STM m) =&gt;
VolatileDB m blk -&gt; STM m (HeaderHash blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#getIsMember"><span class="hs-identifier hs-var">VolatileDB.getIsMember</span></a></span><span>          </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680026211"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span>
</span><span id="line-253"></span><span>      </span><span class="annot"><span class="annottext">STM
  m
  (InvalidBlocks blk
   -&gt; AnchoredFragment (Header blk)
   -&gt; (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
       AnchoredFragment (Header blk)))
-&gt; STM m (InvalidBlocks blk)
-&gt; STM
     m
     (AnchoredFragment (Header blk)
      -&gt; (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
          AnchoredFragment (Header blk)))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var hs-var">forgetFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk)
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (InvalidBlocks blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680026205"><span class="hs-identifier hs-var">cdbInvalid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>      </span><span class="annot"><span class="annottext">STM
  m
  (AnchoredFragment (Header blk)
   -&gt; (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
       AnchoredFragment (Header blk)))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; STM
     m
     (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
      AnchoredFragment (Header blk))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk),
 ConsensusProtocol (BlockProtocol blk)) =&gt;
ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getCurrentChain"><span class="hs-identifier hs-var">Query.getCurrentChain</span></a></span><span>           </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026213"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680026158"><span class="annot"><span class="annottext">immBlockNo :: WithOrigin BlockNo
</span><a href="#local-6989586621680026158"><span class="hs-identifier hs-var hs-var">immBlockNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; WithOrigin BlockNo
forall block. AnchoredFragment block -&gt; WithOrigin BlockNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.anchorBlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026161"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-comment">-- We follow the steps from section &quot;## Adding a block&quot; in ChainDB.md</span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-comment">-- Note: we call 'chainSelectionForFutureBlocks' in all branches instead</span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-comment">-- of once, before branching, because we want to do it /after/ writing the</span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-comment">-- block to the VolatileDB and delivering the 'varBlockWrittenToDisk'</span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-comment">-- promise, as this is the promise the BlockFetch client waits for.</span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-comment">-- Otherwise, the BlockFetch client would have to wait for</span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-comment">-- 'chainSelectionForFutureBlocks'.</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-comment">-- ### Ignore</span><span>
</span><span id="line-268"></span><span>    </span><span id="local-6989586621680026156"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026156"><span class="hs-identifier hs-var">newTip</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span>
</span><span id="line-269"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; IsEBB -&gt; WithOrigin BlockNo -&gt; Bool
forall blk.
HasHeader (Header blk) =&gt;
Header blk -&gt; IsEBB -&gt; WithOrigin BlockNo -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK"><span class="hs-identifier hs-var">olderThanK</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026155"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621680026154"><span class="hs-identifier hs-var">isEBB</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680026158"><span class="hs-identifier hs-var">immBlockNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-270"></span><span>        </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026153"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IgnoreBlockOlderThanK"><span class="hs-identifier hs-var">IgnoreBlockOlderThanK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m ()
</span><a href="#local-6989586621680026150"><span class="hs-identifier hs-var">deliverWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-272"></span><span>        </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-var">chainSelectionForFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026213"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
forall blk. BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#empty"><span class="hs-identifier hs-var">BlockCache.empty</span></a></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Bool
</span><a href="#local-6989586621680026163"><span class="hs-identifier hs-var">isMember</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; HeaderHash blk
forall b. HasHeader b =&gt; b -&gt; HeaderHash b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026153"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IgnoreBlockAlreadyInVolatileDB"><span class="hs-identifier hs-var">IgnoreBlockAlreadyInVolatileDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m ()
</span><a href="#local-6989586621680026150"><span class="hs-identifier hs-var">deliverWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-var">chainSelectionForFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026213"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
forall blk. BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#empty"><span class="hs-identifier hs-var">BlockCache.empty</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlockInfo"><span class="hs-identifier hs-type">InvalidBlockInfo</span></a></span><span> </span><span id="local-6989586621680026145"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680026145"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; InvalidBlocks blk -&gt; Maybe (InvalidBlockInfo blk)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; HeaderHash blk
forall b. HasHeader b =&gt; b -&gt; HeaderHash b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680026162"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-280"></span><span>        </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026153"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; InvalidBlockReason blk -&gt; TraceAddBlockEvent blk
forall blk.
RealPoint blk -&gt; InvalidBlockReason blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IgnoreInvalidBlock"><span class="hs-identifier hs-var">IgnoreInvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680026145"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-281"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m ()
</span><a href="#local-6989586621680026150"><span class="hs-identifier hs-var">deliverWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-var">chainSelectionForFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026213"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
forall blk. BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#empty"><span class="hs-identifier hs-var">BlockCache.empty</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span>      </span><span class="hs-comment">-- The remaining cases</span><span>
</span><span id="line-285"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><span class="annottext">VolatileDB m blk -&gt; blk -&gt; m ()
forall (m :: * -&gt; *) blk.
VolatileDB m blk -&gt; HasCallStack =&gt; blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#putBlock"><span class="hs-identifier hs-var hs-var">VolatileDB.putBlock</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680026211"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-287"></span><span>        </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026153"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; BlockNo -&gt; IsEBB -&gt; TraceAddBlockEvent blk
forall blk.
RealPoint blk -&gt; BlockNo -&gt; IsEBB -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#AddedBlockToVolatileDB"><span class="hs-identifier hs-var">AddedBlockToVolatileDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; BlockNo
forall b. HasHeader b =&gt; b -&gt; BlockNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockNo</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621680026154"><span class="hs-identifier hs-var">isEBB</span></a></span><span>
</span><span id="line-288"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m ()
</span><a href="#local-6989586621680026150"><span class="hs-identifier hs-var">deliverWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680026139"><span class="annot"><span class="annottext">blockCache :: BlockCache blk
</span><a href="#local-6989586621680026139"><span class="hs-identifier hs-var hs-var">blockCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">blk -&gt; BlockCache blk
forall blk. HasHeader blk =&gt; blk -&gt; BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#singleton"><span class="hs-identifier hs-var">BlockCache.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-291"></span><span>        </span><span class="hs-comment">-- Do chain selection for future blocks before chain selection for the</span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-comment">-- new block. When some future blocks are now older than the current</span><span>
</span><span id="line-293"></span><span>        </span><span class="hs-comment">-- block, we will do chain selection in a more chronological order.</span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">m (Point blk) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Point blk) -&gt; m ()) -&gt; m (Point blk) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-var">chainSelectionForFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026213"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621680026139"><span class="hs-identifier hs-var">blockCache</span></a></span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockCache blk -&gt; Header blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk, LedgerSupportsProtocol blk,
 InspectLedger blk, HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; Header blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock"><span class="hs-identifier hs-var">chainSelectionForBlock</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026213"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621680026139"><span class="hs-identifier hs-var">blockCache</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026155"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><span class="annottext">Point blk -&gt; m ()
</span><a href="#local-6989586621680026136"><span class="hs-identifier hs-var">deliverProcessed</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026156"><span class="hs-identifier hs-var">newTip</span></a></span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-299"></span><span>    </span><span class="annot"><a href="#local-6989586621680026153"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-type">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026214"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026215"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621680026153"><span class="annot"><span class="annottext">trace :: TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026153"><span class="hs-identifier hs-var hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceAddBlockEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621680026201"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><a href="#local-6989586621680026155"><span class="hs-identifier hs-type">hdr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026214"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span id="local-6989586621680026155"><span class="annot"><span class="annottext">hdr :: Header blk
</span><a href="#local-6989586621680026155"><span class="hs-identifier hs-var hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">blk -&gt; Header blk
forall blk. GetHeader blk =&gt; blk -&gt; Header blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#getHeader"><span class="hs-identifier hs-var">getHeader</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680026168"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span>    </span><span class="annot"><a href="#local-6989586621680026154"><span class="hs-identifier hs-type">isEBB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621680026154"><span class="annot"><span class="annottext">isEBB :: IsEBB
</span><a href="#local-6989586621680026154"><span class="hs-identifier hs-var hs-var">isEBB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; IsEBB
forall blk. GetHeader blk =&gt; Header blk -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerToIsEBB"><span class="hs-identifier hs-var">headerToIsEBB</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026155"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-comment">-- | Fill in the 'TMVar' for the 'varBlockWrittenToDisk' of the block's</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-comment">-- 'AddBlockPromise' with the given 'Bool'.</span><span>
</span><span id="line-310"></span><span>    </span><span class="annot"><a href="#local-6989586621680026150"><span class="hs-identifier hs-type">deliverWrittenToDisk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026215"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>    </span><span id="local-6989586621680026150"><span class="annot"><span class="annottext">deliverWrittenToDisk :: Bool -&gt; m ()
</span><a href="#local-6989586621680026150"><span class="hs-identifier hs-var hs-var">deliverWrittenToDisk</span></a></span></span><span> </span><span id="local-6989586621680026133"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680026133"><span class="hs-identifier hs-var">writtenToDisk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-312"></span><span>        </span><span class="annot"><span class="annottext">StrictTMVar m Bool -&gt; Bool -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTMVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">putTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m Bool
</span><a href="#local-6989586621680026167"><span class="hs-identifier hs-var">varBlockWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680026133"><span class="hs-identifier hs-var">writtenToDisk</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-comment">-- | Fill in the 'TMVar' for the 'varBlockProcessed' of the block's</span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-comment">-- 'AddBlockPromise' with the given tip.</span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><a href="#local-6989586621680026136"><span class="hs-identifier hs-type">deliverProcessed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026214"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026215"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>    </span><span id="local-6989586621680026136"><span class="annot"><span class="annottext">deliverProcessed :: Point blk -&gt; m ()
</span><a href="#local-6989586621680026136"><span class="hs-identifier hs-var hs-var">deliverProcessed</span></a></span></span><span> </span><span id="local-6989586621680026131"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026131"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-318"></span><span>        </span><span class="annot"><span class="annottext">StrictTMVar m (Point blk) -&gt; Point blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTMVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">putTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m (Point blk)
</span><a href="#local-6989586621680026166"><span class="hs-identifier hs-var">varBlockProcessed</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026131"><span class="hs-identifier hs-var">tip</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="hs-comment">-- | Return 'True' when the given header should be ignored when adding it</span><span>
</span><span id="line-321"></span><span class="hs-comment">-- because it is too old, i.e., we wouldn't be able to switch to a chain</span><span>
</span><span id="line-322"></span><span class="hs-comment">-- containing the corresponding block because its block number is more than</span><span>
</span><span id="line-323"></span><span class="hs-comment">-- @k@ blocks or exactly @k@ blocks back.</span><span>
</span><span id="line-324"></span><span class="hs-comment">--</span><span>
</span><span id="line-325"></span><span class="hs-comment">-- Special case: the header corresponds to an EBB which has the same block</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- number as the block @k@ blocks back (the most recent \&quot;immutable\&quot; block).</span><span>
</span><span id="line-327"></span><span class="hs-comment">-- As EBBs share their block number with the block before them, the EBB is not</span><span>
</span><span id="line-328"></span><span class="hs-comment">-- too old in that case and can be adopted as part of our chain.</span><span>
</span><span id="line-329"></span><span class="hs-comment">--</span><span>
</span><span id="line-330"></span><span class="hs-comment">-- This special case can occur, for example, when the VolatileDB is empty</span><span>
</span><span id="line-331"></span><span class="hs-comment">-- (because of corruption). The \&quot;immutable\&quot; block is then also the tip of</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- the chain. If we then try to add the EBB after it, it will have the same</span><span>
</span><span id="line-333"></span><span class="hs-comment">-- block number, so we must allow it.</span><span>
</span><span id="line-334"></span><span id="local-6989586621680026547"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK"><span class="hs-identifier hs-type">olderThanK</span></a></span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026547"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026547"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-337"></span><span>     </span><span class="hs-comment">-- ^ Header of the block to add</span><span>
</span><span id="line-338"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span>
</span><span id="line-339"></span><span>     </span><span class="hs-comment">-- ^ Whether the block is an EBB or not</span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span>
</span><span id="line-341"></span><span>     </span><span class="hs-comment">-- ^ The block number of the most recent \&quot;immutable\&quot; block, i.e., the</span><span>
</span><span id="line-342"></span><span>     </span><span class="hs-comment">-- block @k@ blocks back.</span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-344"></span><span id="olderThanK"><span class="annot"><span class="annottext">olderThanK :: Header blk -&gt; IsEBB -&gt; WithOrigin BlockNo -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK"><span class="hs-identifier hs-var hs-var">olderThanK</span></a></span></span><span> </span><span id="local-6989586621680026130"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026130"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span id="local-6989586621680026129"><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621680026129"><span class="hs-identifier hs-var">isEBB</span></a></span></span><span> </span><span id="local-6989586621680026128"><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680026128"><span class="hs-identifier hs-var">immBlockNo</span></a></span></span><span>
</span><span id="line-345"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BlockNo -&gt; WithOrigin BlockNo
forall t. t -&gt; WithOrigin t
</span><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621680026126"><span class="hs-identifier hs-var">bNo</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo -&gt; WithOrigin BlockNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680026128"><span class="hs-identifier hs-var">immBlockNo</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621680026129"><span class="hs-identifier hs-var">isEBB</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB -&gt; IsEBB -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-var">IsEBB</span></a></span><span>
</span><span id="line-347"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockNo -&gt; WithOrigin BlockNo
forall t. t -&gt; WithOrigin t
</span><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621680026126"><span class="hs-identifier hs-var">bNo</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo -&gt; WithOrigin BlockNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680026128"><span class="hs-identifier hs-var">immBlockNo</span></a></span><span>
</span><span id="line-350"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-351"></span><span>    </span><span id="local-6989586621680026126"><span class="annot"><span class="annottext">bNo :: BlockNo
</span><a href="#local-6989586621680026126"><span class="hs-identifier hs-var hs-var">bNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; BlockNo
forall b. HasHeader b =&gt; b -&gt; BlockNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockNo</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026130"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="hs-comment">-- | Return the new tip.</span><span>
</span><span id="line-354"></span><span id="local-6989586621680026542"><span id="local-6989586621680026543"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-type">chainSelectionForFutureBlocks</span></a></span><span>
</span><span id="line-355"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026543"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-356"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026542"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-357"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026542"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-358"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026542"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-359"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-360"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026543"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026542"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#BlockCache"><span class="hs-identifier hs-type">BlockCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026542"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026543"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026542"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-362"></span><span id="chainSelectionForFutureBlocks"><span class="annot"><span class="annottext">chainSelectionForFutureBlocks :: ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-var hs-var">chainSelectionForFutureBlocks</span></a></span></span><span> </span><span id="local-6989586621680026123"><span class="annot"><span class="annottext">cdb :: ChainDbEnv m blk
</span><a href="#local-6989586621680026123"><span class="hs-identifier hs-var">cdb</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621680026101"><span id="local-6989586621680026102"><span id="local-6989586621680026103"><span id="local-6989586621680026104"><span id="local-6989586621680026105"><span id="local-6989586621680026106"><span id="local-6989586621680026107"><span id="local-6989586621680026108"><span id="local-6989586621680026109"><span id="local-6989586621680026110"><span id="local-6989586621680026111"><span id="local-6989586621680026112"><span id="local-6989586621680026113"><span id="local-6989586621680026114"><span id="local-6989586621680026115"><span id="local-6989586621680026116"><span id="local-6989586621680026117"><span id="local-6989586621680026118"><span id="local-6989586621680026119"><span id="local-6989586621680026120"><span id="local-6989586621680026121"><span id="local-6989586621680026122"><span class="annot"><span class="annottext">DiffTime
StrictTVar m (m ())
StrictTVar m (FutureBlocks blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbFutureBlocks :: StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: BlocksToAdd m blk
cdbCheckInFuture :: CheckInFuture m blk
cdbCheckIntegrity :: blk -&gt; Bool
cdbChunkInfo :: ChunkInfo
cdbKillBgThreads :: StrictTVar m (m ())
cdbGcInterval :: DiffTime
cdbGcDelay :: DiffTime
cdbRegistry :: ResourceRegistry m
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbTracer :: Tracer m (TraceEvent blk)
cdbCopyLock :: StrictMVar m ()
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: LgrDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbImmutableDB :: ImmutableDB m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
</span><a href="#local-6989586621680026101"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680026100"><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621680026100"><span class="hs-identifier hs-var">blockCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-comment">-- Get 'cdbFutureBlocks' and empty the map in the TVar. It will be</span><span>
</span><span id="line-364"></span><span>    </span><span class="hs-comment">-- repopulated with the blocks that are still from the future (but not the</span><span>
</span><span id="line-365"></span><span>    </span><span class="hs-comment">-- ones no longer from the future) during chain selection for those</span><span>
</span><span id="line-366"></span><span>    </span><span class="hs-comment">-- blocks.</span><span>
</span><span id="line-367"></span><span>    </span><span id="local-6989586621680026099"><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621680026099"><span class="hs-identifier hs-var">futureBlockHeaders</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m [Header blk] -&gt; m [Header blk]
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m [Header blk] -&gt; m [Header blk])
-&gt; STM m [Header blk] -&gt; m [Header blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-368"></span><span>      </span><span id="local-6989586621680026098"><span class="annot"><span class="annottext">FutureBlocks blk
</span><a href="#local-6989586621680026098"><span class="hs-identifier hs-var">futureBlocks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks blk) -&gt; STM m (FutureBlocks blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks blk)
</span><a href="#local-6989586621680026101"><span class="hs-identifier hs-var">cdbFutureBlocks</span></a></span><span>
</span><span id="line-369"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks blk) -&gt; FutureBlocks blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks blk)
</span><a href="#local-6989586621680026101"><span class="hs-identifier hs-var">cdbFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">FutureBlocks blk
forall k a. Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-370"></span><span>      </span><span class="annot"><span class="annottext">[Header blk] -&gt; STM m [Header blk]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">([Header blk] -&gt; STM m [Header blk])
-&gt; [Header blk] -&gt; STM m [Header blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FutureBlocks blk -&gt; [Header blk]
forall k a. Map k a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.elems</span></a></span><span> </span><span class="annot"><span class="annottext">FutureBlocks blk
</span><a href="#local-6989586621680026098"><span class="hs-identifier hs-var">futureBlocks</span></a></span><span>
</span><span id="line-371"></span><span>    </span><span class="annot"><span class="annottext">[Header blk] -&gt; (Header blk -&gt; m (Point blk)) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621680026099"><span class="hs-identifier hs-var">futureBlockHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">((Header blk -&gt; m (Point blk)) -&gt; m ())
-&gt; (Header blk -&gt; m (Point blk)) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680026094"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026094"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>      </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026093"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainSelectionForFutureBlock"><span class="hs-identifier hs-var">ChainSelectionForFutureBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; RealPoint blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#headerRealPoint"><span class="hs-identifier hs-var">headerRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026094"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>      </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockCache blk -&gt; Header blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk, LedgerSupportsProtocol blk,
 InspectLedger blk, HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; Header blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock"><span class="hs-identifier hs-var">chainSelectionForBlock</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026123"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621680026100"><span class="hs-identifier hs-var">blockCache</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026094"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-374"></span><span>    </span><span class="annot"><span class="annottext">STM m (Point blk) -&gt; m (Point blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (Point blk) -&gt; m (Point blk))
-&gt; STM m (Point blk) -&gt; m (Point blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk)) =&gt;
ChainDbEnv m blk -&gt; STM m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getTipPoint"><span class="hs-identifier hs-var">Query.getTipPoint</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026123"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-376"></span><span>    </span><span id="local-6989586621680026093"><span class="annot"><span class="annottext">trace :: TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026093"><span class="hs-identifier hs-var hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceAddBlockEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621680026111"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span class="hs-comment">-- | Trigger chain selection for the given block.</span><span>
</span><span id="line-379"></span><span class="hs-comment">--</span><span>
</span><span id="line-380"></span><span class="hs-comment">-- PRECONDITION: the block is in the VolatileDB.</span><span>
</span><span id="line-381"></span><span class="hs-comment">--</span><span>
</span><span id="line-382"></span><span class="hs-comment">-- PRECONDITION: the slot of the block &lt;= the current (wall) slot</span><span>
</span><span id="line-383"></span><span class="hs-comment">--</span><span>
</span><span id="line-384"></span><span class="hs-comment">-- The new tip of the current chain is returned.</span><span>
</span><span id="line-385"></span><span class="hs-comment">--</span><span>
</span><span id="line-386"></span><span class="hs-comment">-- = Constructing candidate fragments</span><span>
</span><span id="line-387"></span><span class="hs-comment">--</span><span>
</span><span id="line-388"></span><span class="hs-comment">-- The VolatileDB keeps a \&quot;successors\&quot; map in memory, telling us the hashes</span><span>
</span><span id="line-389"></span><span class="hs-comment">-- of the known successors of any block, but it does not keep /headers/ in</span><span>
</span><span id="line-390"></span><span class="hs-comment">-- memory, which are needed to construct candidate fargments. We try to reuse</span><span>
</span><span id="line-391"></span><span class="hs-comment">-- the headers from the current chain fragment where possible, but it will not</span><span>
</span><span id="line-392"></span><span class="hs-comment">-- contain all needed headers. This means that we will need to read some</span><span>
</span><span id="line-393"></span><span class="hs-comment">-- blocks from disk and extract their headers. Under normal circumstances this</span><span>
</span><span id="line-394"></span><span class="hs-comment">-- does not matter too much; although this will be done every time we add a</span><span>
</span><span id="line-395"></span><span class="hs-comment">-- block, the expected number of headers to read from disk is very small:</span><span>
</span><span id="line-396"></span><span class="hs-comment">--</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- * None if we stay on the current chain and this is just the next block</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- * A handful if we stay on the current chain and the block we just received</span><span>
</span><span id="line-399"></span><span class="hs-comment">--   was a missing block and we already received some of its successors</span><span>
</span><span id="line-400"></span><span class="hs-comment">-- * A handful if we switch to a short fork</span><span>
</span><span id="line-401"></span><span class="hs-comment">--</span><span>
</span><span id="line-402"></span><span class="hs-comment">-- This is expensive only</span><span>
</span><span id="line-403"></span><span class="hs-comment">--</span><span>
</span><span id="line-404"></span><span class="hs-comment">-- * on startup: in this case we need to read at least @k@ blocks from the</span><span>
</span><span id="line-405"></span><span class="hs-comment">--   VolatileDB, and possibly more if there are some other chains in the</span><span>
</span><span id="line-406"></span><span class="hs-comment">--   VolatileDB starting from the tip of the ImmutableDB</span><span>
</span><span id="line-407"></span><span class="hs-comment">-- * when we switch to a distant fork</span><span>
</span><span id="line-408"></span><span class="hs-comment">--</span><span>
</span><span id="line-409"></span><span class="hs-comment">-- This cost is currently deemed acceptable.</span><span>
</span><span id="line-410"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock"><span class="hs-identifier hs-type">chainSelectionForBlock</span></a></span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680026529"><span class="annot"><a href="#local-6989586621680026529"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680026528"><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-412"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026529"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-413"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-414"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-415"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-416"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-417"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-418"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026529"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#BlockCache"><span class="hs-identifier hs-type">BlockCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026529"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span id="chainSelectionForBlock"><span class="annot"><span class="annottext">chainSelectionForBlock :: ChainDbEnv m blk -&gt; BlockCache blk -&gt; Header blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock"><span class="hs-identifier hs-var hs-var">chainSelectionForBlock</span></a></span></span><span> </span><span id="local-6989586621680026089"><span class="annot"><span class="annottext">cdb :: ChainDbEnv m blk
</span><a href="#local-6989586621680026089"><span class="hs-identifier hs-var">cdb</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621680026067"><span id="local-6989586621680026068"><span id="local-6989586621680026069"><span id="local-6989586621680026070"><span id="local-6989586621680026071"><span id="local-6989586621680026072"><span id="local-6989586621680026073"><span id="local-6989586621680026074"><span id="local-6989586621680026075"><span id="local-6989586621680026076"><span id="local-6989586621680026077"><span id="local-6989586621680026078"><span id="local-6989586621680026079"><span id="local-6989586621680026080"><span id="local-6989586621680026081"><span id="local-6989586621680026082"><span id="local-6989586621680026083"><span id="local-6989586621680026084"><span id="local-6989586621680026085"><span id="local-6989586621680026086"><span id="local-6989586621680026087"><span id="local-6989586621680026088"><span class="annot"><span class="annottext">DiffTime
StrictTVar m (m ())
StrictTVar m (FutureBlocks blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbFutureBlocks :: StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: BlocksToAdd m blk
cdbCheckInFuture :: CheckInFuture m blk
cdbCheckIntegrity :: blk -&gt; Bool
cdbChunkInfo :: ChunkInfo
cdbKillBgThreads :: StrictTVar m (m ())
cdbGcInterval :: DiffTime
cdbGcDelay :: DiffTime
cdbRegistry :: ResourceRegistry m
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbTracer :: Tracer m (TraceEvent blk)
cdbCopyLock :: StrictMVar m ()
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: LgrDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbImmutableDB :: ImmutableDB m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
</span><a href="#local-6989586621680026067"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680026066"><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621680026066"><span class="hs-identifier hs-var">blockCache</span></a></span></span><span> </span><span id="local-6989586621680026065"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-424"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680026064"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680026064"><span class="hs-identifier hs-var">invalid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026063"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026063"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026062"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621680026062"><span class="hs-identifier hs-var">lookupBlockInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026061"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026061"><span class="hs-identifier hs-var">curChain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026060"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026060"><span class="hs-identifier hs-var">tipPoint</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680026059"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680026059"><span class="hs-identifier hs-var">ledgerDB</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
   HeaderHash blk -&gt; Maybe (BlockInfo blk),
   AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
-&gt; m (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
      HeaderHash blk -&gt; Maybe (BlockInfo blk),
      AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
    HeaderHash blk -&gt; Maybe (BlockInfo blk),
    AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
 -&gt; m (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM
     m
     (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
      HeaderHash blk -&gt; Maybe (BlockInfo blk),
      AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
-&gt; m (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
      HeaderHash blk -&gt; Maybe (BlockInfo blk),
      AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>          </span><span class="annot"><span class="annottext">(InvalidBlocks blk
 -&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
 -&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
 -&gt; AnchoredFragment (Header blk)
 -&gt; Point blk
 -&gt; LedgerDB' blk
 -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
     HeaderHash blk -&gt; Maybe (BlockInfo blk),
     AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (InvalidBlocks blk)
-&gt; STM
     m
     ((ChainHash blk -&gt; Set (HeaderHash blk))
      -&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
      -&gt; AnchoredFragment (Header blk)
      -&gt; Point blk
      -&gt; LedgerDB' blk
      -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
          HeaderHash blk -&gt; Maybe (BlockInfo blk),
          AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var hs-var">forgetFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk)
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (InvalidBlocks blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680026081"><span class="hs-identifier hs-var">cdbInvalid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>          </span><span class="annot"><span class="annottext">STM
  m
  ((ChainHash blk -&gt; Set (HeaderHash blk))
   -&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
   -&gt; AnchoredFragment (Header blk)
   -&gt; Point blk
   -&gt; LedgerDB' blk
   -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; STM
     m
     ((HeaderHash blk -&gt; Maybe (BlockInfo blk))
      -&gt; AnchoredFragment (Header blk)
      -&gt; Point blk
      -&gt; LedgerDB' blk
      -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
          HeaderHash blk -&gt; Maybe (BlockInfo blk),
          AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
forall (m :: * -&gt; *) blk.
VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#filterByPredecessor"><span class="hs-identifier hs-var hs-var">VolatileDB.filterByPredecessor</span></a></span><span>  </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680026087"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span>
</span><span id="line-428"></span><span>          </span><span class="annot"><span class="annottext">STM
  m
  ((HeaderHash blk -&gt; Maybe (BlockInfo blk))
   -&gt; AnchoredFragment (Header blk)
   -&gt; Point blk
   -&gt; LedgerDB' blk
   -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; STM
     m
     (AnchoredFragment (Header blk)
      -&gt; Point blk
      -&gt; LedgerDB' blk
      -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
          HeaderHash blk -&gt; Maybe (BlockInfo blk),
          AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
forall (m :: * -&gt; *) blk.
VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#getBlockInfo"><span class="hs-identifier hs-var hs-var">VolatileDB.getBlockInfo</span></a></span><span>         </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680026087"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span>
</span><span id="line-429"></span><span>          </span><span class="annot"><span class="annottext">STM
  m
  (AnchoredFragment (Header blk)
   -&gt; Point blk
   -&gt; LedgerDB' blk
   -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; STM
     m
     (Point blk
      -&gt; LedgerDB' blk
      -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
          HeaderHash blk -&gt; Maybe (BlockInfo blk),
          AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk),
 ConsensusProtocol (BlockProtocol blk)) =&gt;
ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getCurrentChain"><span class="hs-identifier hs-var">Query.getCurrentChain</span></a></span><span>           </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026089"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-430"></span><span>          </span><span class="annot"><span class="annottext">STM
  m
  (Point blk
   -&gt; LedgerDB' blk
   -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (Point blk)
-&gt; STM
     m
     (LedgerDB' blk
      -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
          HeaderHash blk -&gt; Maybe (BlockInfo blk),
          AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk)) =&gt;
ChainDbEnv m blk -&gt; STM m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getTipPoint"><span class="hs-identifier hs-var">Query.getTipPoint</span></a></span><span>               </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026089"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-431"></span><span>          </span><span class="annot"><span class="annottext">STM
  m
  (LedgerDB' blk
   -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (LedgerDB' blk)
-&gt; STM
     m
     (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
      HeaderHash blk -&gt; Maybe (BlockInfo blk),
      AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; STM m (LedgerDB' blk)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
LgrDB m blk -&gt; STM m (LedgerDB' blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#getCurrent"><span class="hs-identifier hs-var">LgrDB.getCurrent</span></a></span><span>                </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680026086"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span>
</span><span id="line-432"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680026057"><span class="hs-identifier hs-type">curChainAndLedger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-433"></span><span>        </span><span id="local-6989586621680026057"><span class="annot"><span class="annottext">curChainAndLedger :: ChainAndLedger blk
</span><a href="#local-6989586621680026057"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-434"></span><span>          </span><span class="hs-comment">-- The current chain we're working with here is not longer than @k@</span><span>
</span><span id="line-435"></span><span>          </span><span class="hs-comment">-- blocks (see 'getCurrentChain' and 'cdbChain'), which is easier to</span><span>
</span><span id="line-436"></span><span>          </span><span class="hs-comment">-- reason about when doing chain selection, etc.</span><span>
</span><span id="line-437"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; ChainAndLedger blk -&gt; ChainAndLedger blk
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.length</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026061"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680026055"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ChainAndLedger blk -&gt; ChainAndLedger blk)
-&gt; ChainAndLedger blk -&gt; ChainAndLedger blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-438"></span><span>          </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; LedgerDB' blk -&gt; ChainAndLedger blk
forall l b.
(IsLedger l, HasHeader b, HeaderHash b ~ HeaderHash l,
 HasCallStack) =&gt;
AnchoredFragment b -&gt; l -&gt; ValidatedFragment b l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier hs-var">VF.ValidatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026061"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680026059"><span class="hs-identifier hs-var">ledgerDB</span></a></span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span>        </span><span class="annot"><a href="#local-6989586621680026054"><span class="hs-identifier hs-type">immBlockNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span>
</span><span id="line-441"></span><span>        </span><span id="local-6989586621680026054"><span class="annot"><span class="annottext">immBlockNo :: WithOrigin BlockNo
</span><a href="#local-6989586621680026054"><span class="hs-identifier hs-var hs-var">immBlockNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; WithOrigin BlockNo
forall block. AnchoredFragment block -&gt; WithOrigin BlockNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.anchorBlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026061"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-comment">-- Let these two functions ignore invalid blocks</span><span>
</span><span id="line-444"></span><span>        </span><span id="local-6989586621680026053"><span class="annot"><span class="annottext">lookupBlockInfo' :: HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621680026053"><span class="hs-identifier hs-var hs-var">lookupBlockInfo'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
-&gt; InvalidBlocks blk
-&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; HeaderHash blk
-&gt; Maybe (BlockInfo blk)
forall blk (proxy :: * -&gt; *) a.
HasHeader blk =&gt;
proxy blk
-&gt; InvalidBlocks blk
-&gt; (HeaderHash blk -&gt; Maybe a)
-&gt; HeaderHash blk
-&gt; Maybe a
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalid"><span class="hs-identifier hs-var">ignoreInvalid</span></a></span><span>    </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026089"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680026064"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621680026062"><span class="hs-identifier hs-var">lookupBlockInfo</span></a></span><span>
</span><span id="line-445"></span><span>        </span><span id="local-6989586621680026051"><span class="annot"><span class="annottext">succsOf' :: ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026051"><span class="hs-identifier hs-var hs-var">succsOf'</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
-&gt; InvalidBlocks blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
forall blk (proxy :: * -&gt; *).
HasHeader blk =&gt;
proxy blk
-&gt; InvalidBlocks blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalidSuc"><span class="hs-identifier hs-var">ignoreInvalidSuc</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680026089"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680026064"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026063"><span class="hs-identifier hs-var">succsOf</span></a></span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-comment">-- The preconditions</span><span>
</span><span id="line-448"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (BlockInfo blk) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (BlockInfo blk) -&gt; Bool) -&gt; Maybe (BlockInfo blk) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621680026062"><span class="hs-identifier hs-var">lookupBlockInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-keyword">if</span><span>
</span><span id="line-451"></span><span>      </span><span class="hs-comment">-- The chain might have grown since we added the block such that the</span><span>
</span><span id="line-452"></span><span>      </span><span class="hs-comment">-- block is older than @k@.</span><span>
</span><span id="line-453"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; IsEBB -&gt; WithOrigin BlockNo -&gt; Bool
forall blk.
HasHeader (Header blk) =&gt;
Header blk -&gt; IsEBB -&gt; WithOrigin BlockNo -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK"><span class="hs-identifier hs-var">olderThanK</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621680026049"><span class="hs-identifier hs-var">isEBB</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680026054"><span class="hs-identifier hs-var">immBlockNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-454"></span><span>        </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026048"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IgnoreBlockOlderThanK"><span class="hs-identifier hs-var">IgnoreBlockOlderThanK</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680026047"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-455"></span><span>        </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026060"><span class="hs-identifier hs-var">tipPoint</span></a></span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span>      </span><span class="hs-comment">-- We might have validated the block in the meantime</span><span>
</span><span id="line-458"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlockInfo"><span class="hs-identifier hs-type">InvalidBlockInfo</span></a></span><span> </span><span id="local-6989586621680026046"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680026046"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; InvalidBlocks blk -&gt; Maybe (InvalidBlockInfo blk)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680026064"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-459"></span><span>        </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026048"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; InvalidBlockReason blk -&gt; TraceAddBlockEvent blk
forall blk.
RealPoint blk -&gt; InvalidBlockReason blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IgnoreInvalidBlock"><span class="hs-identifier hs-var">IgnoreInvalidBlock</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680026047"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680026046"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-460"></span><span>        </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026060"><span class="hs-identifier hs-var">tipPoint</span></a></span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span>      </span><span class="hs-comment">-- The block @b@ fits onto the end of our current chain</span><span>
</span><span id="line-463"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; ChainHash blk
forall block. Point block -&gt; ChainHash block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">pointHash</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026060"><span class="hs-identifier hs-var">tipPoint</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; ChainHash blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; ChainHash blk
forall blk. GetPrevHash blk =&gt; Header blk -&gt; ChainHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPrevHash"><span class="hs-identifier hs-var">headerPrevHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-464"></span><span>        </span><span class="hs-comment">-- ### Add to current chain</span><span>
</span><span id="line-465"></span><span>        </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026048"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TryAddToCurrentChain"><span class="hs-identifier hs-var">TryAddToCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680026047"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainAndLedger blk -&gt; m (Point blk)
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainAndLedger blk -&gt; m (Point blk)
</span><a href="#local-6989586621680026042"><span class="hs-identifier hs-var">addToCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026051"><span class="hs-identifier hs-var">succsOf'</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026057"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680026041"><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
</span><a href="#local-6989586621680026041"><span class="hs-identifier hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; AnchoredFragment (Header blk)
-&gt; RealPoint blk
-&gt; Maybe (ChainDiff (HeaderFields blk))
forall blk.
(HasHeader blk, GetHeader blk) =&gt;
LookupBlockInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; RealPoint blk
-&gt; Maybe (ChainDiff (HeaderFields blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#isReachable"><span class="hs-identifier hs-var">Paths.isReachable</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621680026053"><span class="hs-identifier hs-var">lookupBlockInfo'</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026061"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680026047"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-469"></span><span>        </span><span class="hs-comment">-- ### Switch to a fork</span><span>
</span><span id="line-470"></span><span>        </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026048"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
-&gt; ChainDiff (HeaderFields blk) -&gt; TraceAddBlockEvent blk
forall blk.
RealPoint blk
-&gt; ChainDiff (HeaderFields blk) -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TrySwitchToAFork"><span class="hs-identifier hs-var">TrySwitchToAFork</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680026047"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
</span><a href="#local-6989586621680026041"><span class="hs-identifier hs-var">diff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-471"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; ChainAndLedger blk
-&gt; ChainDiff (HeaderFields blk)
-&gt; m (Point blk)
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; ChainAndLedger blk
-&gt; ChainDiff (HeaderFields blk)
-&gt; m (Point blk)
</span><a href="#local-6989586621680026038"><span class="hs-identifier hs-var">switchToAFork</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026051"><span class="hs-identifier hs-var">succsOf'</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621680026053"><span class="hs-identifier hs-var">lookupBlockInfo'</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026057"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
</span><a href="#local-6989586621680026041"><span class="hs-identifier hs-var">diff</span></a></span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-474"></span><span>        </span><span class="hs-comment">-- ### Store but don't change the current chain</span><span>
</span><span id="line-475"></span><span>        </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026048"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#StoreButDontChange"><span class="hs-identifier hs-var">StoreButDontChange</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680026047"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>        </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026060"><span class="hs-identifier hs-var">tipPoint</span></a></span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span>    </span><span class="hs-comment">-- Note that we may have extended the chain, but have not trimmed it to</span><span>
</span><span id="line-479"></span><span>    </span><span class="hs-comment">-- @k@ blocks/headers. That is the job of the background thread, which</span><span>
</span><span id="line-480"></span><span>    </span><span class="hs-comment">-- will first copy the blocks/headers to trim (from the end of the</span><span>
</span><span id="line-481"></span><span>    </span><span class="hs-comment">-- fragment) from the VolatileDB to the ImmutableDB.</span><span>
</span><span id="line-482"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-483"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span id="local-6989586621680026055"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680026055"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; SecurityParam
forall blk.
ConsensusProtocol (BlockProtocol blk) =&gt;
TopLevelConfig blk -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Config.html#configSecurityParam"><span class="hs-identifier hs-var">configSecurityParam</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680026082"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span>    </span><span class="annot"><a href="#local-6989586621680026047"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-486"></span><span>    </span><span id="local-6989586621680026047"><span class="annot"><span class="annottext">p :: RealPoint blk
</span><a href="#local-6989586621680026047"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; RealPoint blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#headerRealPoint"><span class="hs-identifier hs-var">headerRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>    </span><span class="annot"><a href="#local-6989586621680026049"><span class="hs-identifier hs-type">isEBB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span id="local-6989586621680026049"><span class="annot"><span class="annottext">isEBB :: IsEBB
</span><a href="#local-6989586621680026049"><span class="hs-identifier hs-var hs-var">isEBB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; IsEBB
forall blk. GetHeader blk =&gt; Header blk -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerToIsEBB"><span class="hs-identifier hs-var">headerToIsEBB</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>    </span><span class="annot"><a href="#local-6989586621680026048"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-type">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026529"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>    </span><span id="local-6989586621680026048"><span class="annot"><span class="annottext">trace :: TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026048"><span class="hs-identifier hs-var hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceAddBlockEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621680026077"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span>    </span><span class="annot"><a href="#local-6989586621680026034"><span class="hs-identifier hs-type">mkChainSelEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026529"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-495"></span><span>    </span><span id="local-6989586621680026034"><span class="annot"><span class="annottext">mkChainSelEnv :: ChainAndLedger blk -&gt; ChainSelEnv m blk
</span><a href="#local-6989586621680026034"><span class="hs-identifier hs-var hs-var">mkChainSelEnv</span></a></span></span><span> </span><span id="local-6989586621680026033"><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026033"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainSelEnv :: forall (m :: * -&gt; *) blk.
LgrDB m blk
-&gt; (TraceValidationEvent blk -&gt; m ())
-&gt; BlockConfig blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; StrictTVar m (FutureBlocks blk)
-&gt; CheckInFuture m blk
-&gt; BlockCache blk
-&gt; ChainAndLedger blk
-&gt; ChainSelEnv m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span>
</span><span id="line-496"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lgrDB :: LgrDB m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#lgrDB"><span class="hs-identifier hs-var">lgrDB</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680026086"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span>
</span><span id="line-497"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">bcfg :: BlockConfig blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#bcfg"><span class="hs-identifier hs-var">bcfg</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; BlockConfig blk
forall blk. TopLevelConfig blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configBlock"><span class="hs-identifier hs-var">configBlock</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680026082"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>
</span><span id="line-498"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">varInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varInvalid"><span class="hs-identifier hs-var">varInvalid</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680026081"><span class="hs-identifier hs-var">cdbInvalid</span></a></span><span>
</span><span id="line-499"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">varFutureBlocks :: StrictTVar m (FutureBlocks blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varFutureBlocks"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks blk)
</span><a href="#local-6989586621680026067"><span class="hs-identifier hs-var">cdbFutureBlocks</span></a></span><span>
</span><span id="line-500"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">futureCheck :: CheckInFuture m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheck"><span class="hs-identifier hs-var">futureCheck</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckInFuture m blk
</span><a href="#local-6989586621680026069"><span class="hs-identifier hs-var">cdbCheckInFuture</span></a></span><span>
</span><span id="line-501"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blockCache :: BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#blockCache"><span class="hs-identifier hs-var">blockCache</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621680026066"><span class="hs-identifier hs-var">blockCache</span></a></span><span>
</span><span id="line-502"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">curChainAndLedger :: ChainAndLedger blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#curChainAndLedger"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026033"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-503"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">trace :: TraceValidationEvent blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#trace"><span class="hs-identifier hs-var">trace</span></a></span><span>             </span><span class="hs-glyph">=</span><span>
</span><span id="line-504"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
-&gt; TraceValidationEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceValidationEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceValidationEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; (TraceValidationEvent blk -&gt; TraceAddBlockEvent blk)
-&gt; TraceValidationEvent blk
-&gt; TraceEvent blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; TraceAddBlockEvent blk
forall blk. TraceValidationEvent blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#AddBlockValidation"><span class="hs-identifier hs-var">AddBlockValidation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621680026077"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-506"></span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-comment">-- | PRECONDITION: the header @hdr@ (and block @b@) fit onto the end of</span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-comment">-- the current chain.</span><span>
</span><span id="line-509"></span><span>    </span><span class="annot"><a href="#local-6989586621680026042"><span class="hs-identifier hs-type">addToCurrentChain</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-510"></span><span>         </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-511"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-513"></span><span>         </span><span class="hs-comment">-- ^ The current chain and ledger</span><span>
</span><span id="line-514"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026529"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>    </span><span id="local-6989586621680026042"><span class="annot"><span class="annottext">addToCurrentChain :: (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainAndLedger blk -&gt; m (Point blk)
</span><a href="#local-6989586621680026042"><span class="hs-identifier hs-var hs-var">addToCurrentChain</span></a></span></span><span> </span><span id="local-6989586621680026031"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026031"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span> </span><span id="local-6989586621680026030"><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026030"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-516"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680026029"><span class="annot"><span class="annottext">suffixesAfterB :: [NonEmpty (HeaderHash blk)]
</span><a href="#local-6989586621680026029"><span class="hs-identifier hs-var hs-var">suffixesAfterB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; Point blk -&gt; [NonEmpty (HeaderHash blk)]
forall blk.
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; Point blk -&gt; [NonEmpty (HeaderHash blk)]
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#maximalCandidates"><span class="hs-identifier hs-var">Paths.maximalCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026031"><span class="hs-identifier hs-var">succsOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk -&gt; Point blk
forall blk. RealPoint blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#realPointToPoint"><span class="hs-identifier hs-var">realPointToPoint</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680026047"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span>        </span><span class="hs-comment">-- Fragments that are anchored at @curHead@, i.e. suffixes of the</span><span>
</span><span id="line-519"></span><span>        </span><span class="hs-comment">-- current chain.</span><span>
</span><span id="line-520"></span><span>        </span><span id="local-6989586621680026027"><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026027"><span class="hs-identifier hs-var">candidates</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[NonEmpty (HeaderHash blk)]
-&gt; Maybe (NonEmpty (NonEmpty (HeaderHash blk)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[NonEmpty (HeaderHash blk)]
</span><a href="#local-6989586621680026029"><span class="hs-identifier hs-var">suffixesAfterB</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-521"></span><span>          </span><span class="hs-comment">-- If there are no suffixes after @b@, just use the suffix just</span><span>
</span><span id="line-522"></span><span>          </span><span class="hs-comment">-- containing @b@ as the sole candidate.</span><span>
</span><span id="line-523"></span><span>          </span><span class="annot"><span class="annottext">Maybe (NonEmpty (NonEmpty (HeaderHash blk)))
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>              </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-524"></span><span>            </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
-&gt; m (NonEmpty (AnchoredFragment (Header blk)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmpty (AnchoredFragment (Header blk))
 -&gt; m (NonEmpty (AnchoredFragment (Header blk))))
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; m (NonEmpty (AnchoredFragment (Header blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Anchor (Header blk)
-&gt; [Header blk] -&gt; AnchoredFragment (Header blk)
forall v a b. Anchorable v a b =&gt; a -&gt; [b] -&gt; AnchoredSeq v a b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.fromOldestFirst</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk)
</span><a href="#local-6989586621680026026"><span class="hs-identifier hs-var">curHead</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; [AnchoredFragment (Header blk)]
-&gt; NonEmpty (AnchoredFragment (Header blk))
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">NE.:|</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-525"></span><span>          </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680026024"><span class="annot"><span class="annottext">NonEmpty (NonEmpty (HeaderHash blk))
</span><a href="#local-6989586621680026024"><span class="hs-identifier hs-var">suffixesAfterB'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-526"></span><span>            </span><span class="hs-comment">-- We can start with an empty cache, because we're only looking</span><span>
</span><span id="line-527"></span><span>            </span><span class="hs-comment">-- up the headers /after/ b, so they won't be on the current</span><span>
</span><span id="line-528"></span><span>            </span><span class="hs-comment">-- chain.</span><span>
</span><span id="line-529"></span><span>            </span><span class="annot"><span class="annottext">(StateT
   (FutureBlocks blk) m (NonEmpty (AnchoredFragment (Header blk)))
 -&gt; FutureBlocks blk
 -&gt; m (NonEmpty (AnchoredFragment (Header blk))))
-&gt; FutureBlocks blk
-&gt; StateT
     (FutureBlocks blk) m (NonEmpty (AnchoredFragment (Header blk)))
-&gt; m (NonEmpty (AnchoredFragment (Header blk)))
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">StateT
  (FutureBlocks blk) m (NonEmpty (AnchoredFragment (Header blk)))
-&gt; FutureBlocks blk -&gt; m (NonEmpty (AnchoredFragment (Header blk)))
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">evalStateT</span></a></span><span> </span><span class="annot"><span class="annottext">FutureBlocks blk
forall k a. Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT
   (FutureBlocks blk) m (NonEmpty (AnchoredFragment (Header blk)))
 -&gt; m (NonEmpty (AnchoredFragment (Header blk))))
-&gt; StateT
     (FutureBlocks blk) m (NonEmpty (AnchoredFragment (Header blk)))
-&gt; m (NonEmpty (AnchoredFragment (Header blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (NonEmpty (HeaderHash blk))
-&gt; (NonEmpty (HeaderHash blk)
    -&gt; StateT (FutureBlocks blk) m (AnchoredFragment (Header blk)))
-&gt; StateT
     (FutureBlocks blk) m (NonEmpty (AnchoredFragment (Header blk)))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">forM</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (NonEmpty (HeaderHash blk))
</span><a href="#local-6989586621680026024"><span class="hs-identifier hs-var">suffixesAfterB'</span></a></span><span> </span><span class="annot"><span class="annottext">((NonEmpty (HeaderHash blk)
  -&gt; StateT (FutureBlocks blk) m (AnchoredFragment (Header blk)))
 -&gt; StateT
      (FutureBlocks blk) m (NonEmpty (AnchoredFragment (Header blk))))
-&gt; (NonEmpty (HeaderHash blk)
    -&gt; StateT (FutureBlocks blk) m (AnchoredFragment (Header blk)))
-&gt; StateT
     (FutureBlocks blk) m (NonEmpty (AnchoredFragment (Header blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680026022"><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
</span><a href="#local-6989586621680026022"><span class="hs-identifier hs-var">hashes</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-530"></span><span>              </span><span id="local-6989586621680026021"><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621680026021"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; StateT (FutureBlocks blk) m (Header blk))
-&gt; [HeaderHash blk] -&gt; StateT (FutureBlocks blk) m [Header blk]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HeaderHash blk -&gt; StateT (FutureBlocks blk) m (Header blk)
forall (m :: * -&gt; *) blk.
(MonadThrow m, HasHeader blk) =&gt;
VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getKnownHeaderThroughCache"><span class="hs-identifier hs-var">getKnownHeaderThroughCache</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680026087"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([HeaderHash blk] -&gt; StateT (FutureBlocks blk) m [Header blk])
-&gt; [HeaderHash blk] -&gt; StateT (FutureBlocks blk) m [Header blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-531"></span><span>                        </span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk) -&gt; [HeaderHash blk]
forall a. NonEmpty a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
</span><a href="#local-6989586621680026022"><span class="hs-identifier hs-var">hashes</span></a></span><span>
</span><span id="line-532"></span><span>              </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; StateT (FutureBlocks blk) m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk)
 -&gt; StateT (FutureBlocks blk) m (AnchoredFragment (Header blk)))
-&gt; AnchoredFragment (Header blk)
-&gt; StateT (FutureBlocks blk) m (AnchoredFragment (Header blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk)
-&gt; [Header blk] -&gt; AnchoredFragment (Header blk)
forall v a b. Anchorable v a b =&gt; a -&gt; [b] -&gt; AnchoredSeq v a b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.fromOldestFirst</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk)
</span><a href="#local-6989586621680026026"><span class="hs-identifier hs-var">curHead</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; [Header blk] -&gt; [Header blk]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621680026021"><span class="hs-identifier hs-var">hdrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680026020"><span class="annot"><span class="annottext">chainDiffs :: Maybe (NonEmpty (ChainDiff (Header blk)))
</span><a href="#local-6989586621680026020"><span class="hs-identifier hs-var hs-var">chainDiffs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
-&gt; Maybe (NonEmpty (ChainDiff (Header blk)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span>
</span><span id="line-535"></span><span>              </span><span class="annot"><span class="annottext">([ChainDiff (Header blk)]
 -&gt; Maybe (NonEmpty (ChainDiff (Header blk))))
-&gt; [ChainDiff (Header blk)]
-&gt; Maybe (NonEmpty (ChainDiff (Header blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; Bool)
-&gt; NonEmpty (ChainDiff (Header blk)) -&gt; [ChainDiff (Header blk)]
forall a. (a -&gt; Bool) -&gt; NonEmpty a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">NE.filter</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; BlockConfig blk
forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#bcfg"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680026018"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026017"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-536"></span><span>                          </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; (ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var hs-var">Diff.getSuffix</span></a></span><span>
</span><span id="line-537"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>              </span><span class="annot"><span class="annottext">(NonEmpty (ChainDiff (Header blk)) -&gt; [ChainDiff (Header blk)])
-&gt; NonEmpty (ChainDiff (Header blk)) -&gt; [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; ChainDiff (Header blk))
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; NonEmpty (ChainDiff (Header blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; ChainDiff (Header blk)
forall b. AnchoredFragment b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#extend"><span class="hs-identifier hs-var">Diff.extend</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026027"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-539"></span><span>        </span><span class="hs-comment">-- All candidates are longer than the current chain, so they will be</span><span>
</span><span id="line-540"></span><span>        </span><span class="hs-comment">-- preferred over it, /unless/ the block we just added is an EBB,</span><span>
</span><span id="line-541"></span><span>        </span><span class="hs-comment">-- which has the same 'BlockNo' as the block before it, so when</span><span>
</span><span id="line-542"></span><span>        </span><span class="hs-comment">-- using the 'BlockNo' as the proxy for the length (note that some</span><span>
</span><span id="line-543"></span><span>        </span><span class="hs-comment">-- protocols might do it differently), the candidate with the EBB</span><span>
</span><span id="line-544"></span><span>        </span><span class="hs-comment">-- appended will not be preferred over the current chain.</span><span>
</span><span id="line-545"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-546"></span><span>        </span><span class="hs-comment">-- The consequence of this is that when adding an EBB, it will not</span><span>
</span><span id="line-547"></span><span>        </span><span class="hs-comment">-- be selected by chain selection and thus not appended to the chain</span><span>
</span><span id="line-548"></span><span>        </span><span class="hs-comment">-- until the block after it is added, which will again result in a</span><span>
</span><span id="line-549"></span><span>        </span><span class="hs-comment">-- candidate preferred over the current chain. In this case, the</span><span>
</span><span id="line-550"></span><span>        </span><span class="hs-comment">-- candidate will be a two-block (the EBB and the new block)</span><span>
</span><span id="line-551"></span><span>        </span><span class="hs-comment">-- extension of the current chain.</span><span>
</span><span id="line-552"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty (ChainDiff (Header blk)))
</span><a href="#local-6989586621680026020"><span class="hs-identifier hs-var">chainDiffs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-553"></span><span>          </span><span class="annot"><span class="annottext">Maybe (NonEmpty (ChainDiff (Header blk)))
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026015"><span class="hs-identifier hs-var">curTip</span></a></span><span>
</span><span id="line-554"></span><span>          </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680026014"><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621680026014"><span class="hs-identifier hs-var">chainDiffs'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-555"></span><span>            </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelection"><span class="hs-identifier hs-var">chainSelection</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680026018"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621680026014"><span class="hs-identifier hs-var">chainDiffs'</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
    -&gt; m (Point blk))
-&gt; m (Point blk)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-556"></span><span>              </span><span class="annot"><span class="annottext">Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-557"></span><span>                </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680026015"><span class="hs-identifier hs-var">curTip</span></a></span><span>
</span><span id="line-558"></span><span>              </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680026013"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680026013"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-559"></span><span>                </span><span class="annot"><span class="annottext">HasCallStack =&gt;
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ([LedgerEvent blk]
    -&gt; NewTipInfo blk
    -&gt; AnchoredFragment (Header blk)
    -&gt; AnchoredFragment (Header blk)
    -&gt; TraceAddBlockEvent blk)
-&gt; m (Point blk)
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ([LedgerEvent blk]
    -&gt; NewTipInfo blk
    -&gt; AnchoredFragment (Header blk)
    -&gt; AnchoredFragment (Header blk)
    -&gt; TraceAddBlockEvent blk)
-&gt; m (Point blk)
</span><a href="#local-6989586621680026012"><span class="hs-identifier hs-var">switchTo</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680026013"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
-&gt; NewTipInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
forall blk.
[LedgerEvent blk]
-&gt; NewTipInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#AddedToCurrentChain"><span class="hs-identifier hs-var">AddedToCurrentChain</span></a></span><span>
</span><span id="line-560"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-561"></span><span>        </span><span id="local-6989586621680026018"><span class="annot"><span class="annottext">chainSelEnv :: ChainSelEnv m blk
</span><a href="#local-6989586621680026018"><span class="hs-identifier hs-var hs-var">chainSelEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; ChainSelEnv m blk
</span><a href="#local-6989586621680026034"><span class="hs-identifier hs-var">mkChainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026030"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-562"></span><span>        </span><span id="local-6989586621680026017"><span class="annot"><span class="annottext">curChain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026017"><span class="hs-identifier hs-var hs-var">curChain</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; AnchoredFragment (Header blk)
forall b l. ValidatedFragment b l -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedFragment"><span class="hs-identifier hs-var hs-var">VF.validatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026030"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-563"></span><span>        </span><span id="local-6989586621680026015"><span class="annot"><span class="annottext">curTip :: Point blk
</span><a href="#local-6989586621680026015"><span class="hs-identifier hs-var hs-var">curTip</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026017"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-564"></span><span>        </span><span id="local-6989586621680026026"><span class="annot"><span class="annottext">curHead :: Anchor (Header blk)
</span><a href="#local-6989586621680026026"><span class="hs-identifier hs-var hs-var">curHead</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Anchor (Header blk)
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026017"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-comment">-- | We have found a 'ChainDiff' through the VolatileDB connecting the new</span><span>
</span><span id="line-567"></span><span>    </span><span class="hs-comment">-- block to the current chain. We'll call the intersection/anchor @x@.</span><span>
</span><span id="line-568"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-569"></span><span>    </span><span class="hs-comment">-- We try to extend this path by looking for forks that start with the</span><span>
</span><span id="line-570"></span><span>    </span><span class="hs-comment">-- given block, then we do chain selection and /possibly/ try to switch to</span><span>
</span><span id="line-571"></span><span>    </span><span class="hs-comment">-- a new fork.</span><span>
</span><span id="line-572"></span><span>    </span><span class="annot"><a href="#local-6989586621680026038"><span class="hs-identifier hs-type">switchToAFork</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-573"></span><span>         </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-574"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#LookupBlockInfo"><span class="hs-identifier hs-type">LookupBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-576"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-577"></span><span>         </span><span class="hs-comment">-- ^ The current chain (anchored at @i@) and ledger</span><span>
</span><span id="line-578"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderFields</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span>         </span><span class="hs-comment">-- ^ Header fields for @(x,b]@</span><span>
</span><span id="line-580"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026529"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-581"></span><span>    </span><span id="local-6989586621680026038"><span class="annot"><span class="annottext">switchToAFork :: (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; ChainAndLedger blk
-&gt; ChainDiff (HeaderFields blk)
-&gt; m (Point blk)
</span><a href="#local-6989586621680026038"><span class="hs-identifier hs-var hs-var">switchToAFork</span></a></span></span><span> </span><span id="local-6989586621680026008"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026008"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span> </span><span id="local-6989586621680026007"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621680026007"><span class="hs-identifier hs-var">lookupBlockInfo</span></a></span></span><span> </span><span id="local-6989586621680026006"><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026006"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span></span><span> </span><span id="local-6989586621680026005"><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
</span><a href="#local-6989586621680026005"><span class="hs-identifier hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-582"></span><span>        </span><span class="hs-comment">-- We use a cache to avoid reading the headers from disk multiple</span><span>
</span><span id="line-583"></span><span>        </span><span class="hs-comment">-- times in case they're part of multiple forks that go through @b@.</span><span>
</span><span id="line-584"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680026004"><span class="annot"><span class="annottext">initCache :: FutureBlocks blk
</span><a href="#local-6989586621680026004"><span class="hs-identifier hs-var hs-var">initCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Header blk -&gt; FutureBlocks blk
forall k a. k -&gt; a -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680026065"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-585"></span><span>        </span><span id="local-6989586621680026002"><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680026002"><span class="hs-identifier hs-var">chainDiffs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-586"></span><span>          </span><span class="hs-comment">-- 4. Filter out candidates that are not preferred over the current</span><span>
</span><span id="line-587"></span><span>          </span><span class="hs-comment">-- chain.</span><span>
</span><span id="line-588"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-589"></span><span>          </span><span class="hs-comment">-- The suffixes all fork off from the current chain within @k@</span><span>
</span><span id="line-590"></span><span>          </span><span class="hs-comment">-- blocks, so it satisfies the precondition of 'preferCandidate'.</span><span>
</span><span id="line-591"></span><span>            </span><span class="annot"><span class="annottext">([ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)])
-&gt; m [ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span>
</span><span id="line-592"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; Bool)
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span>
</span><span id="line-593"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; BlockConfig blk
forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#bcfg"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680026001"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026000"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-594"></span><span>                  </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; (ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var hs-var">Diff.getSuffix</span></a></span><span>
</span><span id="line-595"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-596"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>            </span><span class="hs-comment">-- 3. Translate the 'HeaderFields' to 'Header' by reading the</span><span>
</span><span id="line-598"></span><span>            </span><span class="hs-comment">-- headers from disk.</span><span>
</span><span id="line-599"></span><span>          </span><span class="annot"><span class="annottext">(m [ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)])
-&gt; (ChainDiff (HeaderFields blk) -&gt; m [ChainDiff (Header blk)])
-&gt; ChainDiff (HeaderFields blk)
-&gt; m [ChainDiff (Header blk)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT (FutureBlocks blk) m [ChainDiff (Header blk)]
 -&gt; FutureBlocks blk -&gt; m [ChainDiff (Header blk)])
-&gt; FutureBlocks blk
-&gt; StateT (FutureBlocks blk) m [ChainDiff (Header blk)]
-&gt; m [ChainDiff (Header blk)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">StateT (FutureBlocks blk) m [ChainDiff (Header blk)]
-&gt; FutureBlocks blk -&gt; m [ChainDiff (Header blk)]
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">evalStateT</span></a></span><span> </span><span class="annot"><span class="annottext">FutureBlocks blk
</span><a href="#local-6989586621680026004"><span class="hs-identifier hs-var">initCache</span></a></span><span>
</span><span id="line-600"></span><span>          </span><span class="annot"><span class="annottext">(StateT (FutureBlocks blk) m [ChainDiff (Header blk)]
 -&gt; m [ChainDiff (Header blk)])
-&gt; (ChainDiff (HeaderFields blk)
    -&gt; StateT (FutureBlocks blk) m [ChainDiff (Header blk)])
-&gt; ChainDiff (HeaderFields blk)
-&gt; m [ChainDiff (Header blk)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (HeaderFields blk)
 -&gt; StateT (FutureBlocks blk) m (ChainDiff (Header blk)))
-&gt; [ChainDiff (HeaderFields blk)]
-&gt; StateT (FutureBlocks blk) m [ChainDiff (Header blk)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
-&gt; StateT (FutureBlocks blk) m (ChainDiff (Header blk))
</span><a href="#local-6989586621680025999"><span class="hs-identifier hs-var">translateToHeaders</span></a></span><span>
</span><span id="line-601"></span><span>            </span><span class="hs-comment">-- 2. Filter out candidates that are shorter than the current</span><span>
</span><span id="line-602"></span><span>            </span><span class="hs-comment">-- chain. We don't want to needlessly read the headers from disk</span><span>
</span><span id="line-603"></span><span>            </span><span class="hs-comment">-- for those candidates.</span><span>
</span><span id="line-604"></span><span>          </span><span class="annot"><span class="annottext">([ChainDiff (HeaderFields blk)]
 -&gt; StateT (FutureBlocks blk) m [ChainDiff (Header blk)])
-&gt; (ChainDiff (HeaderFields blk) -&gt; [ChainDiff (HeaderFields blk)])
-&gt; ChainDiff (HeaderFields blk)
-&gt; StateT (FutureBlocks blk) m [ChainDiff (Header blk)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (HeaderFields blk) -&gt; Bool)
-&gt; NonEmpty (ChainDiff (HeaderFields blk))
-&gt; [ChainDiff (HeaderFields blk)]
forall a. (a -&gt; Bool) -&gt; NonEmpty a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">NE.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (ChainDiff (HeaderFields blk) -&gt; Bool)
-&gt; ChainDiff (HeaderFields blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk) -&gt; Bool
forall b. HasHeader b =&gt; ChainDiff b -&gt; Bool
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#rollbackExceedsSuffix"><span class="hs-identifier hs-var">Diff.rollbackExceedsSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-605"></span><span>            </span><span class="hs-comment">-- 1. Extend the diff with candidates fitting on @B@</span><span>
</span><span id="line-606"></span><span>          </span><span class="annot"><span class="annottext">(NonEmpty (ChainDiff (HeaderFields blk))
 -&gt; [ChainDiff (HeaderFields blk)])
-&gt; (ChainDiff (HeaderFields blk)
    -&gt; NonEmpty (ChainDiff (HeaderFields blk)))
-&gt; ChainDiff (HeaderFields blk)
-&gt; [ChainDiff (HeaderFields blk)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; ChainDiff (HeaderFields blk)
-&gt; NonEmpty (ChainDiff (HeaderFields blk))
forall blk.
HasHeader blk =&gt;
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; LookupBlockInfo blk
-&gt; ChainDiff (HeaderFields blk)
-&gt; NonEmpty (ChainDiff (HeaderFields blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#extendWithSuccessors"><span class="hs-identifier hs-var">Paths.extendWithSuccessors</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680026008"><span class="hs-identifier hs-var">succsOf</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621680026007"><span class="hs-identifier hs-var">lookupBlockInfo</span></a></span><span>
</span><span id="line-607"></span><span>          </span><span class="annot"><span class="annottext">(ChainDiff (HeaderFields blk) -&gt; m [ChainDiff (Header blk)])
-&gt; ChainDiff (HeaderFields blk) -&gt; m [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
</span><a href="#local-6989586621680026005"><span class="hs-identifier hs-var">diff</span></a></span><span>
</span><span id="line-608"></span><span>
</span><span id="line-609"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
-&gt; Maybe (NonEmpty (ChainDiff (Header blk)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680026002"><span class="hs-identifier hs-var">chainDiffs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-610"></span><span>          </span><span class="hs-comment">-- No candidates preferred over the current chain</span><span>
</span><span id="line-611"></span><span>          </span><span class="annot"><span class="annottext">Maybe (NonEmpty (ChainDiff (Header blk)))
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680025995"><span class="hs-identifier hs-var">curTip</span></a></span><span>
</span><span id="line-612"></span><span>          </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680025994"><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621680025994"><span class="hs-identifier hs-var">chainDiffs'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-613"></span><span>            </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelection"><span class="hs-identifier hs-var">chainSelection</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680026001"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621680025994"><span class="hs-identifier hs-var">chainDiffs'</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
    -&gt; m (Point blk))
-&gt; m (Point blk)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-614"></span><span>              </span><span class="annot"><span class="annottext">Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                 </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-615"></span><span>                </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680025995"><span class="hs-identifier hs-var">curTip</span></a></span><span>
</span><span id="line-616"></span><span>              </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680025993"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025993"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-617"></span><span>                </span><span class="annot"><span class="annottext">HasCallStack =&gt;
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ([LedgerEvent blk]
    -&gt; NewTipInfo blk
    -&gt; AnchoredFragment (Header blk)
    -&gt; AnchoredFragment (Header blk)
    -&gt; TraceAddBlockEvent blk)
-&gt; m (Point blk)
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ([LedgerEvent blk]
    -&gt; NewTipInfo blk
    -&gt; AnchoredFragment (Header blk)
    -&gt; AnchoredFragment (Header blk)
    -&gt; TraceAddBlockEvent blk)
-&gt; m (Point blk)
</span><a href="#local-6989586621680026012"><span class="hs-identifier hs-var">switchTo</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025993"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
-&gt; NewTipInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
forall blk.
[LedgerEvent blk]
-&gt; NewTipInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#SwitchedToAFork"><span class="hs-identifier hs-var">SwitchedToAFork</span></a></span><span>
</span><span id="line-618"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-619"></span><span>        </span><span id="local-6989586621680026001"><span class="annot"><span class="annottext">chainSelEnv :: ChainSelEnv m blk
</span><a href="#local-6989586621680026001"><span class="hs-identifier hs-var hs-var">chainSelEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; ChainSelEnv m blk
</span><a href="#local-6989586621680026034"><span class="hs-identifier hs-var">mkChainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026006"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-620"></span><span>        </span><span id="local-6989586621680026000"><span class="annot"><span class="annottext">curChain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026000"><span class="hs-identifier hs-var hs-var">curChain</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; AnchoredFragment (Header blk)
forall b l. ValidatedFragment b l -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedFragment"><span class="hs-identifier hs-var hs-var">VF.validatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680026006"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-621"></span><span>        </span><span id="local-6989586621680025995"><span class="annot"><span class="annottext">curTip :: Point blk
</span><a href="#local-6989586621680025995"><span class="hs-identifier hs-var hs-var">curTip</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680026000"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-622"></span><span>
</span><span id="line-623"></span><span>    </span><span class="hs-comment">-- | Create a 'NewTipInfo' corresponding to the tip of the given ledger.</span><span>
</span><span id="line-624"></span><span>    </span><span class="annot"><a href="#local-6989586621680025991"><span class="hs-identifier hs-type">mkNewTipInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#NewTipInfo"><span class="hs-identifier hs-type">NewTipInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-625"></span><span>    </span><span id="local-6989586621680025991"><span class="annot"><span class="annottext">mkNewTipInfo :: LedgerDB' blk -&gt; NewTipInfo blk
</span><a href="#local-6989586621680025991"><span class="hs-identifier hs-var hs-var">mkNewTipInfo</span></a></span></span><span> </span><span id="local-6989586621680025990"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025990"><span class="hs-identifier hs-var">newLedgerDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-626"></span><span>        </span><span class="annot"><span class="annottext">NewTipInfo :: forall blk.
RealPoint blk
-&gt; EpochNo -&gt; Word64 -&gt; RealPoint blk -&gt; NewTipInfo blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#NewTipInfo"><span class="hs-identifier hs-type">NewTipInfo</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-627"></span><span>            </span><span class="annot"><span class="annottext">newTipPoint :: RealPoint blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#newTipPoint"><span class="hs-identifier hs-var">newTipPoint</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680025987"><span class="hs-identifier hs-var">tipPoint</span></a></span><span>
</span><span id="line-628"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">newTipEpoch :: EpochNo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#newTipEpoch"><span class="hs-identifier hs-var">newTipEpoch</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621680025985"><span class="hs-identifier hs-var">tipEpoch</span></a></span><span>
</span><span id="line-629"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">newTipSlotInEpoch :: Word64
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#newTipSlotInEpoch"><span class="hs-identifier hs-var">newTipSlotInEpoch</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680025983"><span class="hs-identifier hs-var">tipSlotInEpoch</span></a></span><span>
</span><span id="line-630"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">newTipTrigger :: RealPoint blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#newTipTrigger"><span class="hs-identifier hs-var">newTipTrigger</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680026047"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-631"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-632"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-633"></span><span>        </span><span class="annot"><a href="#local-6989586621680025981"><span class="hs-identifier hs-type">cfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.html#TopLevelConfig"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-634"></span><span>        </span><span id="local-6989586621680025981"><span class="annot"><span class="annottext">cfg :: TopLevelConfig blk
</span><a href="#local-6989586621680025981"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680026082"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>
</span><span id="line-635"></span><span>
</span><span id="line-636"></span><span>        </span><span class="annot"><a href="#local-6989586621680025980"><span class="hs-identifier hs-type">ledger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-637"></span><span>        </span><span id="local-6989586621680025980"><span class="annot"><span class="annottext">ledger :: LedgerState blk
</span><a href="#local-6989586621680025980"><span class="hs-identifier hs-var hs-var">ledger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; ExtLedgerState blk
forall l. GetTip l =&gt; LedgerDB l -&gt; l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.InMemory.html#ledgerDbCurrent"><span class="hs-identifier hs-var">LgrDB.ledgerDbCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025990"><span class="hs-identifier hs-var">newLedgerDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-638"></span><span>
</span><span id="line-639"></span><span>        </span><span class="annot"><a href="#local-6989586621680025977"><span class="hs-identifier hs-type">summary</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.History.Summary.html#Summary"><span class="hs-identifier hs-type">History.Summary</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HardForkIndices"><span class="hs-identifier hs-type">HardForkIndices</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span>        </span><span id="local-6989586621680025977"><span class="annot"><span class="annottext">summary :: Summary (HardForkIndices blk)
</span><a href="#local-6989586621680025977"><span class="hs-identifier hs-var hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; LedgerState blk -&gt; Summary (HardForkIndices blk)
forall blk.
HasHardForkHistory blk =&gt;
LedgerConfig blk
-&gt; LedgerState blk -&gt; Summary (HardForkIndices blk)
</span><a href="Ouroboros.Consensus.HardFork.Abstract.html#hardForkSummary"><span class="hs-identifier hs-var">hardForkSummary</span></a></span><span>
</span><span id="line-641"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configLedger"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680025981"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>                    </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680025980"><span class="hs-identifier hs-var">ledger</span></a></span><span>
</span><span id="line-643"></span><span>
</span><span id="line-644"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621680025987"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680025987"><span class="hs-identifier hs-var">tipPoint</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680025985"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621680025985"><span class="hs-identifier hs-var">tipEpoch</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025983"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680025983"><span class="hs-identifier hs-var">tipSlotInEpoch</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-645"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; WithOrigin (RealPoint blk)
forall blk. Point blk -&gt; WithOrigin (RealPoint blk)
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#pointToWithOriginRealPoint"><span class="hs-identifier hs-var">pointToWithOriginRealPoint</span></a></span><span>
</span><span id="line-646"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; LedgerState blk -&gt; Point blk
forall blk.
UpdateLedger blk =&gt;
Proxy blk -&gt; LedgerState blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Ledger.Abstract.html#ledgerTipPoint"><span class="hs-identifier hs-var">ledgerTipPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk
forall k (t :: k). Proxy t
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680025980"><span class="hs-identifier hs-var">ledger</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-647"></span><span>            </span><span class="annot"><span class="annottext">WithOrigin (RealPoint blk)
</span><span class="hs-identifier hs-var">Origin</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; (RealPoint blk, (EpochNo, Word64))
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cannot have switched to an empty chain&quot;</span></span><span>
</span><span id="line-648"></span><span>            </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span id="local-6989586621680025970"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680025970"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-649"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680025969"><span class="annot"><span class="annottext">query :: Qry (EpochNo, Word64)
</span><a href="#local-6989586621680025969"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Qry (EpochNo, Word64)
</span><a href="Ouroboros.Consensus.HardFork.History.Qry.html#slotToEpoch%27"><span class="hs-identifier hs-var">History.slotToEpoch'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk -&gt; SlotNo
forall blk. RealPoint blk -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#realPointSlot"><span class="hs-identifier hs-var">realPointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680025970"><span class="hs-identifier hs-var">tip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span>              </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680025970"><span class="hs-identifier hs-var">tip</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Qry (EpochNo, Word64)
-&gt; Summary (HardForkIndices blk) -&gt; (EpochNo, Word64)
forall a (xs :: [*]). HasCallStack =&gt; Qry a -&gt; Summary xs -&gt; a
</span><a href="Ouroboros.Consensus.HardFork.History.Qry.html#runQueryPure"><span class="hs-identifier hs-var">History.runQueryPure</span></a></span><span> </span><span class="annot"><span class="annottext">Qry (EpochNo, Word64)
</span><a href="#local-6989586621680025969"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">Summary (HardForkIndices blk)
</span><a href="#local-6989586621680025977"><span class="hs-identifier hs-var">summary</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>
</span><span id="line-652"></span><span>    </span><span class="hs-comment">-- | Try to apply the given 'ChainDiff' on the current chain fragment. The</span><span>
</span><span id="line-653"></span><span>    </span><span class="hs-comment">-- 'LgrDB.LedgerDB' is updated in the same transaction.</span><span>
</span><span id="line-654"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-655"></span><span>    </span><span class="hs-comment">-- Note that we /cannot/ have switched to a different current chain in the</span><span>
</span><span id="line-656"></span><span>    </span><span class="hs-comment">-- meantime, since this function will only be called by a single</span><span>
</span><span id="line-657"></span><span>    </span><span class="hs-comment">-- background thread.</span><span>
</span><span id="line-658"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-659"></span><span>    </span><span class="hs-comment">-- It /is/ possible that the background thread copying headers older than</span><span>
</span><span id="line-660"></span><span>    </span><span class="hs-comment">-- @k@ from the VolatileDB to the ImmutableDB has removed some headers</span><span>
</span><span id="line-661"></span><span>    </span><span class="hs-comment">-- from the beginning of the current chain fragment, but does not affect</span><span>
</span><span id="line-662"></span><span>    </span><span class="hs-comment">-- us, as we cannot roll back more than @k@ headers anyway.</span><span>
</span><span id="line-663"></span><span>    </span><span class="annot"><a href="#local-6989586621680026012"><span class="hs-identifier hs-type">switchTo</span></a></span><span>
</span><span id="line-664"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-665"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-666"></span><span>         </span><span class="hs-comment">-- ^ Chain and ledger to switch to</span><span>
</span><span id="line-667"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span>    </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#LedgerEvent"><span class="hs-identifier hs-type">LedgerEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-668"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#NewTipInfo"><span class="hs-identifier hs-type">NewTipInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-669"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-670"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-671"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-type">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-672"></span><span>         </span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span>         </span><span class="hs-comment">-- ^ Given the 'NewTipInfo', the previous chain, and the new chain,</span><span>
</span><span id="line-674"></span><span>         </span><span class="hs-comment">-- return the event to trace when we switched to the new chain.</span><span>
</span><span id="line-675"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026529"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-676"></span><span>    </span><span id="local-6989586621680026012"><span class="annot"><span class="annottext">switchTo :: ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ([LedgerEvent blk]
    -&gt; NewTipInfo blk
    -&gt; AnchoredFragment (Header blk)
    -&gt; AnchoredFragment (Header blk)
    -&gt; TraceAddBlockEvent blk)
-&gt; m (Point blk)
</span><a href="#local-6989586621680026012"><span class="hs-identifier hs-var hs-var">switchTo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span id="local-6989586621680025965"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025965"><span class="hs-identifier hs-var">chainDiff</span></a></span></span><span> </span><span id="local-6989586621680025964"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025964"><span class="hs-identifier hs-var">newLedger</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680025963"><span class="annot"><span class="annottext">[LedgerEvent blk]
-&gt; NewTipInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
</span><a href="#local-6989586621680025963"><span class="hs-identifier hs-var">mkTraceEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-677"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621680025962"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025962"><span class="hs-identifier hs-var">curChain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025961"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025961"><span class="hs-identifier hs-var">newChain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025960"><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621680025960"><span class="hs-identifier hs-var">events</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
   [LedgerEvent blk])
-&gt; m (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
      [LedgerEvent blk])
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
    [LedgerEvent blk])
 -&gt; m (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
       [LedgerEvent blk]))
-&gt; STM
     m
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
      [LedgerEvent blk])
-&gt; m (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
      [LedgerEvent blk])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-678"></span><span>          </span><span id="local-6989586621680025959"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025959"><span class="hs-identifier hs-var">curChain</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span>         </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026085"><span class="hs-identifier hs-var">cdbChain</span></a></span><span> </span><span class="hs-comment">-- Not Query.getCurrentChain!</span><span>
</span><span id="line-679"></span><span>          </span><span id="local-6989586621680025958"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025958"><span class="hs-identifier hs-var">curLedger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; STM m (LedgerDB' blk)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
LgrDB m blk -&gt; STM m (LedgerDB' blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#getCurrent"><span class="hs-identifier hs-var">LgrDB.getCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680026086"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span>
</span><span id="line-680"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; ChainDiff (Header blk) -&gt; Maybe (AnchoredFragment (Header blk))
forall b.
HasHeader b =&gt;
AnchoredFragment b -&gt; ChainDiff b -&gt; Maybe (AnchoredFragment b)
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#apply"><span class="hs-identifier hs-var">Diff.apply</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025959"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025965"><span class="hs-identifier hs-var">chainDiff</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-681"></span><span>            </span><span class="hs-comment">-- Impossible, as described in the docstring</span><span>
</span><span id="line-682"></span><span>            </span><span class="annot"><span class="annottext">Maybe (AnchoredFragment (Header blk))
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-683"></span><span>              </span><span class="annot"><span class="annottext">[Char]
-&gt; STM
     m
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
      [LedgerEvent blk])
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;chainDiff doesn't fit onto current chain&quot;</span></span><span>
</span><span id="line-684"></span><span>            </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680025956"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025956"><span class="hs-identifier hs-var">newChain</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-685"></span><span>              </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; AnchoredFragment (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680026085"><span class="hs-identifier hs-var">cdbChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025956"><span class="hs-identifier hs-var">newChain</span></a></span><span>
</span><span id="line-686"></span><span>              </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; LedgerDB' blk -&gt; STM m ()
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
LgrDB m blk -&gt; LedgerDB' blk -&gt; STM m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#setCurrent"><span class="hs-identifier hs-var">LgrDB.setCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680026086"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025964"><span class="hs-identifier hs-var">newLedger</span></a></span><span>
</span><span id="line-687"></span><span>
</span><span id="line-688"></span><span>              </span><span class="hs-comment">-- Inspect the new ledger for potential problems</span><span>
</span><span id="line-689"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680025954"><span class="hs-identifier hs-type">events</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#LedgerEvent"><span class="hs-identifier hs-type">LedgerEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-690"></span><span>                  </span><span id="local-6989586621680025954"><span class="annot"><span class="annottext">events :: [LedgerEvent blk]
</span><a href="#local-6989586621680025954"><span class="hs-identifier hs-var hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; LedgerState blk -&gt; LedgerState blk -&gt; [LedgerEvent blk]
forall blk.
InspectLedger blk =&gt;
TopLevelConfig blk
-&gt; LedgerState blk -&gt; LedgerState blk -&gt; [LedgerEvent blk]
</span><a href="Ouroboros.Consensus.Ledger.Inspect.html#inspectLedger"><span class="hs-identifier hs-var">inspectLedger</span></a></span><span>
</span><span id="line-691"></span><span>                             </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680026082"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>
</span><span id="line-692"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; LedgerState blk)
-&gt; ExtLedgerState blk -&gt; LedgerState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; ExtLedgerState blk
forall l. GetTip l =&gt; LedgerDB l -&gt; l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.InMemory.html#ledgerDbCurrent"><span class="hs-identifier hs-var">LgrDB.ledgerDbCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025958"><span class="hs-identifier hs-var">curLedger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-693"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; LedgerState blk)
-&gt; ExtLedgerState blk -&gt; LedgerState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; ExtLedgerState blk
forall l. GetTip l =&gt; LedgerDB l -&gt; l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.InMemory.html#ledgerDbCurrent"><span class="hs-identifier hs-var">LgrDB.ledgerDbCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025964"><span class="hs-identifier hs-var">newLedger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-694"></span><span>
</span><span id="line-695"></span><span>              </span><span class="hs-comment">-- Update the followers</span><span>
</span><span id="line-696"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-697"></span><span>              </span><span class="hs-comment">-- 'Follower.switchFork' needs to know the intersection point</span><span>
</span><span id="line-698"></span><span>              </span><span class="hs-comment">-- (@ipoint@) between the old and the current chain.</span><span>
</span><span id="line-699"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680025952"><span class="annot"><span class="annottext">ipoint :: Point blk
</span><a href="#local-6989586621680025952"><span class="hs-identifier hs-var hs-var">ipoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; Point (Header blk)
forall b. ChainDiff b -&gt; Point b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getAnchorPoint"><span class="hs-identifier hs-var">Diff.getAnchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025965"><span class="hs-identifier hs-var">chainDiff</span></a></span><span>
</span><span id="line-700"></span><span>              </span><span id="local-6989586621680025950"><span class="annot"><span class="annottext">[FollowerHandle m blk]
</span><a href="#local-6989586621680025950"><span class="hs-identifier hs-var">followerHandles</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map FollowerKey (FollowerHandle m blk) -&gt; [FollowerHandle m blk]
forall k a. Map k a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.elems</span></a></span><span> </span><span class="annot"><span class="annottext">(Map FollowerKey (FollowerHandle m blk) -&gt; [FollowerHandle m blk])
-&gt; STM m (Map FollowerKey (FollowerHandle m blk))
-&gt; STM m [FollowerHandle m blk]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map FollowerKey (FollowerHandle m blk))
-&gt; STM m (Map FollowerKey (FollowerHandle m blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map FollowerKey (FollowerHandle m blk))
</span><a href="#local-6989586621680026083"><span class="hs-identifier hs-var">cdbFollowers</span></a></span><span>
</span><span id="line-701"></span><span>              </span><span class="annot"><span class="annottext">[FollowerHandle m blk]
-&gt; (FollowerHandle m blk -&gt; STM m ()) -&gt; STM m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[FollowerHandle m blk]
</span><a href="#local-6989586621680025950"><span class="hs-identifier hs-var">followerHandles</span></a></span><span> </span><span class="annot"><span class="annottext">((FollowerHandle m blk -&gt; STM m ()) -&gt; STM m ())
-&gt; (FollowerHandle m blk -&gt; STM m ()) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680025949"><span class="annot"><span class="annottext">FollowerHandle m blk
</span><a href="#local-6989586621680025949"><span class="hs-identifier hs-var">followerHandle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-702"></span><span>                </span><span class="annot"><span class="annottext">FollowerHandle m blk
-&gt; Point blk -&gt; AnchoredFragment (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) blk.
FollowerHandle m blk
-&gt; Point blk -&gt; AnchoredFragment (Header blk) -&gt; STM m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#fhSwitchFork"><span class="hs-identifier hs-var hs-var">fhSwitchFork</span></a></span><span> </span><span class="annot"><span class="annottext">FollowerHandle m blk
</span><a href="#local-6989586621680025949"><span class="hs-identifier hs-var">followerHandle</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680025952"><span class="hs-identifier hs-var">ipoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025956"><span class="hs-identifier hs-var">newChain</span></a></span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span>              </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk), AnchoredFragment (Header blk),
 [LedgerEvent blk])
-&gt; STM
     m
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
      [LedgerEvent blk])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025959"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025956"><span class="hs-identifier hs-var">newChain</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621680025954"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-705"></span><span>
</span><span id="line-706"></span><span>        </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; m ()
</span><a href="#local-6989586621680026048"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
-&gt; NewTipInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
</span><a href="#local-6989586621680025963"><span class="hs-identifier hs-var">mkTraceEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621680025960"><span class="hs-identifier hs-var">events</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; NewTipInfo blk
</span><a href="#local-6989586621680025991"><span class="hs-identifier hs-var">mkNewTipInfo</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025964"><span class="hs-identifier hs-var">newLedger</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025962"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025961"><span class="hs-identifier hs-var">newChain</span></a></span><span>
</span><span id="line-707"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (LedgerDB' blk) -&gt; LedgerDB' blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (LedgerDB' blk)
</span><a href="#local-6989586621680026076"><span class="hs-identifier hs-var">cdbTraceLedger</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025964"><span class="hs-identifier hs-var">newLedger</span></a></span><span>
</span><span id="line-708"></span><span>
</span><span id="line-709"></span><span>        </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Point blk -&gt; m (Point blk)) -&gt; Point blk -&gt; m (Point blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025961"><span class="hs-identifier hs-var">newChain</span></a></span><span>
</span><span id="line-710"></span><span>
</span><span id="line-711"></span><span>    </span><span class="hs-comment">-- | We have a new block @b@ that doesn't fit onto the current chain, but</span><span>
</span><span id="line-712"></span><span>    </span><span class="hs-comment">-- we have found a 'ChainDiff' connecting it to the current chain via</span><span>
</span><span id="line-713"></span><span>    </span><span class="hs-comment">-- intersection point @x@. We may also have extended that 'ChainDiff' with</span><span>
</span><span id="line-714"></span><span>    </span><span class="hs-comment">-- more blocks fitting onto @b@, i.e., a suffix @s@.</span><span>
</span><span id="line-715"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-716"></span><span>    </span><span class="hs-comment">-- We now translate that 'ChainDiff' from 'HeaderFields' to 'Header's by</span><span>
</span><span id="line-717"></span><span>    </span><span class="hs-comment">-- reading the headers from disk.</span><span>
</span><span id="line-718"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-719"></span><span>    </span><span class="hs-comment">-- Note that we need to read the headers corresponding to the hashes</span><span>
</span><span id="line-720"></span><span>    </span><span class="hs-comment">-- @(x,b)@ and @(b,?]@ from disk. Not for @b@, as that's in our cache.</span><span>
</span><span id="line-721"></span><span>    </span><span class="annot"><a href="#local-6989586621680025999"><span class="hs-identifier hs-type">translateToHeaders</span></a></span><span>
</span><span id="line-722"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderFields</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-723"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-type">StateT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span>                </span><span class="annot"><a href="#local-6989586621680026529"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-725"></span><span>                </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026528"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-726"></span><span>         </span><span class="hs-comment">-- ^ Fork, anchored at @x@, contains (the header of) @b@ and ends</span><span>
</span><span id="line-727"></span><span>         </span><span class="hs-comment">-- with the suffix @s@.</span><span>
</span><span id="line-728"></span><span>    </span><span id="local-6989586621680025999"><span class="annot"><span class="annottext">translateToHeaders :: ChainDiff (HeaderFields blk)
-&gt; StateT (FutureBlocks blk) m (ChainDiff (Header blk))
</span><a href="#local-6989586621680025999"><span class="hs-identifier hs-var hs-var">translateToHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-729"></span><span>        </span><span class="annot"><span class="annottext">(HeaderFields blk -&gt; StateT (FutureBlocks blk) m (Header blk))
-&gt; ChainDiff (HeaderFields blk)
-&gt; StateT (FutureBlocks blk) m (ChainDiff (Header blk))
forall a b (m :: * -&gt; *).
(HasHeader b, HeaderHash a ~ HeaderHash b, Monad m) =&gt;
(a -&gt; m b) -&gt; ChainDiff a -&gt; m (ChainDiff b)
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#mapM"><span class="hs-identifier hs-var">Diff.mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HeaderHash blk -&gt; StateT (FutureBlocks blk) m (Header blk)
forall (m :: * -&gt; *) blk.
(MonadThrow m, HasHeader blk) =&gt;
VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getKnownHeaderThroughCache"><span class="hs-identifier hs-var">getKnownHeaderThroughCache</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680026087"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span> </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; StateT (FutureBlocks blk) m (Header blk))
-&gt; (HeaderFields blk -&gt; HeaderHash blk)
-&gt; HeaderFields blk
-&gt; StateT (FutureBlocks blk) m (Header blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderFields blk -&gt; HeaderHash blk
forall b. HeaderFields b -&gt; HeaderHash b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var hs-var">headerFieldHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-730"></span><span>
</span><span id="line-731"></span><span class="hs-comment">-- | Check whether the header for the hash is in the cache, if not, get</span><span>
</span><span id="line-732"></span><span class="hs-comment">-- the corresponding header from the VolatileDB and store it in the cache.</span><span>
</span><span id="line-733"></span><span class="hs-comment">--</span><span>
</span><span id="line-734"></span><span class="hs-comment">-- PRECONDITION: the header (block) must exist in the VolatileDB.</span><span>
</span><span id="line-735"></span><span id="local-6989586621680026614"><span id="local-6989586621680026616"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getKnownHeaderThroughCache"><span class="hs-identifier hs-type">getKnownHeaderThroughCache</span></a></span><span>
</span><span id="line-736"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026616"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026614"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#VolatileDB"><span class="hs-identifier hs-type">VolatileDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026616"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026614"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-738"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026614"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-739"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-type">StateT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026614"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026614"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680026616"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026614"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-740"></span><span id="getKnownHeaderThroughCache"><span class="annot"><span class="annottext">getKnownHeaderThroughCache :: VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getKnownHeaderThroughCache"><span class="hs-identifier hs-var hs-var">getKnownHeaderThroughCache</span></a></span></span><span> </span><span id="local-6989586621680025945"><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680025945"><span class="hs-identifier hs-var">volatileDB</span></a></span></span><span> </span><span id="local-6989586621680025944"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680025944"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map (HeaderHash blk) (Header blk) -&gt; Maybe (Header blk))
-&gt; StateT
     (Map (HeaderHash blk) (Header blk)) m (Maybe (Header blk))
forall (m :: * -&gt; *) s a. Monad m =&gt; (s -&gt; a) -&gt; StateT s m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk
-&gt; Map (HeaderHash blk) (Header blk) -&gt; Maybe (Header blk)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680025944"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StateT (Map (HeaderHash blk) (Header blk)) m (Maybe (Header blk))
-&gt; (Maybe (Header blk)
    -&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk))
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-741"></span><span>    </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680025942"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025942"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Header blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025942"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-742"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Header blk)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-743"></span><span>      </span><span id="local-6989586621680025941"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025941"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Header blk)
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Header blk)
 -&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk))
-&gt; m (Header blk)
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; BlockComponent blk (Header blk)
-&gt; HeaderHash blk
-&gt; m (Header blk)
forall (m :: * -&gt; *) blk b.
(MonadThrow m, HasHeader blk) =&gt;
VolatileDB m blk -&gt; BlockComponent blk b -&gt; HeaderHash blk -&gt; m b
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#getKnownBlockComponent"><span class="hs-identifier hs-var">VolatileDB.getKnownBlockComponent</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680025945"><span class="hs-identifier hs-var">volatileDB</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk (Header blk)
forall blk. BlockComponent blk (Header blk)
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetHeader"><span class="hs-identifier hs-var">GetHeader</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680025944"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-744"></span><span>      </span><span class="annot"><span class="annottext">(Map (HeaderHash blk) (Header blk)
 -&gt; Map (HeaderHash blk) (Header blk))
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m ()
forall (m :: * -&gt; *) s. Monad m =&gt; (s -&gt; s) -&gt; StateT s m ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk
-&gt; Header blk
-&gt; Map (HeaderHash blk) (Header blk)
-&gt; Map (HeaderHash blk) (Header blk)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680025944"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025941"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span>      </span><span class="annot"><span class="annottext">Header blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025941"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-746"></span><span>
</span><span id="line-747"></span><span class="hs-comment">-- | Environment used by 'chainSelection' and related functions.</span><span>
</span><span id="line-748"></span><span class="hs-keyword">data</span><span> </span><span id="ChainSelEnv"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-var">ChainSelEnv</span></a></span></span><span> </span><span id="local-6989586621680026594"><span class="annot"><a href="#local-6989586621680026594"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680026593"><span class="annot"><a href="#local-6989586621680026593"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ChainSelEnv"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-var">ChainSelEnv</span></a></span></span><span>
</span><span id="line-749"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="lgrDB"><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; LgrDB m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#lgrDB"><span class="hs-identifier hs-var hs-var">lgrDB</span></a></span></span><span>             </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDB"><span class="hs-identifier hs-type">LgrDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026593"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-750"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="trace"><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; TraceValidationEvent blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#trace"><span class="hs-identifier hs-var hs-var">trace</span></a></span></span><span>             </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceValidationEvent"><span class="hs-identifier hs-type">TraceValidationEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026593"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-751"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="bcfg"><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#bcfg"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span></span><span>              </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockConfig"><span class="hs-identifier hs-type">BlockConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026593"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-752"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="varInvalid"><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varInvalid"><span class="hs-identifier hs-var hs-var">varInvalid</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlocks"><span class="hs-identifier hs-type">InvalidBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026593"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-753"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="varFutureBlocks"><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varFutureBlocks"><span class="hs-identifier hs-var hs-var">varFutureBlocks</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#FutureBlocks"><span class="hs-identifier hs-type">FutureBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026593"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-754"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="futureCheck"><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; CheckInFuture m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheck"><span class="hs-identifier hs-var hs-var">futureCheck</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.InFuture.html#CheckInFuture"><span class="hs-identifier hs-type">CheckInFuture</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026593"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-755"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="blockCache"><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#blockCache"><span class="hs-identifier hs-var hs-var">blockCache</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#BlockCache"><span class="hs-identifier hs-type">BlockCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026593"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-756"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="curChainAndLedger"><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; ChainAndLedger blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#curChainAndLedger"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026593"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-757"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-758"></span><span>
</span><span id="line-759"></span><span class="hs-comment">-- | Perform chain selection with the given candidates. If a validated</span><span>
</span><span id="line-760"></span><span class="hs-comment">-- candidate was chosen to replace the current chain, return it along with the</span><span>
</span><span id="line-761"></span><span class="hs-comment">-- corresponding ledger.</span><span>
</span><span id="line-762"></span><span class="hs-comment">--</span><span>
</span><span id="line-763"></span><span class="hs-comment">-- PRECONDITION: all candidates must be preferred over the current chain.</span><span>
</span><span id="line-764"></span><span class="hs-comment">--</span><span>
</span><span id="line-765"></span><span class="hs-comment">-- PRECONDITION: the candidate chain diffs must fit on the (given) current</span><span>
</span><span id="line-766"></span><span class="hs-comment">-- chain.</span><span>
</span><span id="line-767"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelection"><span class="hs-identifier hs-type">chainSelection</span></a></span><span>
</span><span id="line-768"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680026600"><span class="annot"><a href="#local-6989586621680026600"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680026599"><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-769"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026600"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-770"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-771"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-772"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-773"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026600"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-774"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-775"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026600"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-776"></span><span>     </span><span class="hs-comment">-- ^ The (valid) chain diff and corresponding LedgerDB that was selected,</span><span>
</span><span id="line-777"></span><span>     </span><span class="hs-comment">-- or 'Nothing' if there is no valid chain diff preferred over the</span><span>
</span><span id="line-778"></span><span>     </span><span class="hs-comment">-- current chain.</span><span>
</span><span id="line-779"></span><span id="chainSelection"><span class="annot"><span class="annottext">chainSelection :: ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelection"><span class="hs-identifier hs-var hs-var">chainSelection</span></a></span></span><span> </span><span id="local-6989586621680025935"><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680025935"><span class="hs-identifier hs-var">chainSelEnv</span></a></span></span><span> </span><span id="local-6989586621680025934"><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621680025934"><span class="hs-identifier hs-var">chainDiffs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-780"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; Bool)
-&gt; NonEmpty (ChainDiff (Header blk)) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621680025933"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025932"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; (ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var hs-var">Diff.getSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span>                </span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621680025934"><span class="hs-identifier hs-var">chainDiffs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-782"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; Bool)
-&gt; NonEmpty (ChainDiff (Header blk)) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (AnchoredFragment (Header blk)) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (AnchoredFragment (Header blk)) -&gt; Bool)
-&gt; (ChainDiff (Header blk)
    -&gt; Maybe (AnchoredFragment (Header blk)))
-&gt; ChainDiff (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; ChainDiff (Header blk) -&gt; Maybe (AnchoredFragment (Header blk))
forall b.
HasHeader b =&gt;
AnchoredFragment b -&gt; ChainDiff b -&gt; Maybe (AnchoredFragment b)
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#apply"><span class="hs-identifier hs-var">Diff.apply</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025932"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-783"></span><span>                </span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621680025934"><span class="hs-identifier hs-var">chainDiffs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-784"></span><span>    </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621680025931"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
</span><a href="#local-6989586621680025930"><span class="hs-identifier hs-var">sortCandidates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk)) -&gt; [ChainDiff (Header blk)]
forall a. NonEmpty a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621680025934"><span class="hs-identifier hs-var">chainDiffs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-786"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680025933"><span class="annot"><span class="annottext">BlockConfig blk
bcfg :: BlockConfig blk
bcfg :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockConfig blk
</span><a href="#local-6989586621680025933"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025929"><span class="annot"><span class="annottext">ChainAndLedger blk
curChainAndLedger :: ChainAndLedger blk
curChainAndLedger :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; ChainAndLedger blk
</span><a href="#local-6989586621680025929"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025928"><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680025928"><span class="hs-identifier hs-var hs-var">varInvalid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025927"><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks blk)
varFutureBlocks :: StrictTVar m (FutureBlocks blk)
varFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
</span><a href="#local-6989586621680025927"><span class="hs-identifier hs-var hs-var">varFutureBlocks</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-787"></span><span>      </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680025935"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span>
</span><span id="line-788"></span><span>
</span><span id="line-789"></span><span>    </span><span id="local-6989586621680025932"><span class="annot"><span class="annottext">curChain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025932"><span class="hs-identifier hs-var hs-var">curChain</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; AnchoredFragment (Header blk)
forall b l. ValidatedFragment b l -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedFragment"><span class="hs-identifier hs-var hs-var">VF.validatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680025929"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-790"></span><span>
</span><span id="line-791"></span><span>    </span><span class="annot"><a href="#local-6989586621680025930"><span class="hs-identifier hs-type">sortCandidates</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-792"></span><span>    </span><span id="local-6989586621680025930"><span class="annot"><span class="annottext">sortCandidates :: [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
</span><a href="#local-6989586621680025930"><span class="hs-identifier hs-var hs-var">sortCandidates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-793"></span><span>      </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; ChainDiff (Header blk) -&gt; Ordering)
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">sortBy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk)
 -&gt; AnchoredFragment (Header blk) -&gt; Ordering)
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Ordering
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Ordering
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Ordering
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#compareAnchoredFragments"><span class="hs-identifier hs-var">compareAnchoredFragments</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621680025933"><span class="hs-identifier hs-var">bcfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk)
 -&gt; AnchoredFragment (Header blk) -&gt; Ordering)
-&gt; (ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk)
-&gt; ChainDiff (Header blk)
-&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var hs-var">Diff.getSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>
</span><span id="line-795"></span><span>    </span><span class="hs-comment">-- 1. Take the first candidate from the list of sorted candidates</span><span>
</span><span id="line-796"></span><span>    </span><span class="hs-comment">-- 2. Validate it</span><span>
</span><span id="line-797"></span><span>    </span><span class="hs-comment">--    - If it is invalid -&gt; discard it and go to 1 with the rest of the</span><span>
</span><span id="line-798"></span><span>    </span><span class="hs-comment">--      list.</span><span>
</span><span id="line-799"></span><span>    </span><span class="hs-comment">--    - If it is valid and has the same tip -&gt; return it</span><span>
</span><span id="line-800"></span><span>    </span><span class="hs-comment">--    - If it is valid, but is a prefix of the original -&gt;</span><span>
</span><span id="line-801"></span><span>    </span><span class="hs-comment">--        add it to the list, sort it and go to 1. See the comment</span><span>
</span><span id="line-802"></span><span>    </span><span class="hs-comment">--        [Ouroboros] below.</span><span>
</span><span id="line-803"></span><span>    </span><span class="annot"><a href="#local-6989586621680025931"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-804"></span><span>         </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-805"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026600"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>    </span><span id="local-6989586621680025931"><span class="annot"><span class="annottext">go :: [ChainDiff (Header blk)]
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621680025931"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a. Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-807"></span><span>    </span><span class="annot"><a href="#local-6989586621680025931"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680025925"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025925"><span class="hs-identifier hs-var">candidate</span></a></span></span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621680025924"><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025924"><span class="hs-identifier hs-var">candidates0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-808"></span><span>      </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; ChainDiff (Header blk) -&gt; m (ValidationResult blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; ChainDiff (Header blk) -&gt; m (ValidationResult blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validateCandidate"><span class="hs-identifier hs-var">validateCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680025935"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025925"><span class="hs-identifier hs-var">candidate</span></a></span><span> </span><span class="annot"><span class="annottext">m (ValidationResult blk)
-&gt; (ValidationResult blk
    -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-809"></span><span>        </span><span class="annot"><span class="annottext">ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#InsufficientSuffix"><span class="hs-identifier hs-var">InsufficientSuffix</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-810"></span><span>          </span><span id="local-6989586621680025921"><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025921"><span class="hs-identifier hs-var">candidates1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
</span><a href="#local-6989586621680025920"><span class="hs-identifier hs-var">truncateRejectedBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025924"><span class="hs-identifier hs-var">candidates0</span></a></span><span>
</span><span id="line-811"></span><span>          </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621680025931"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
</span><a href="#local-6989586621680025930"><span class="hs-identifier hs-var">sortCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025921"><span class="hs-identifier hs-var">candidates1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-812"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#FullyValid"><span class="hs-identifier hs-type">FullyValid</span></a></span><span> </span><span id="local-6989586621680025918"><span class="annot"><span class="annottext">validatedCandidate :: ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025918"><span class="hs-identifier hs-var">validatedCandidate</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span id="local-6989586621680025917"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025917"><span class="hs-identifier hs-var">candidate'</span></a></span></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-813"></span><span>          </span><span class="hs-comment">-- The entire candidate is valid</span><span>
</span><span id="line-814"></span><span>          </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; Point (Header blk)
forall b. HasHeader b =&gt; ChainDiff b -&gt; Point b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getTip"><span class="hs-identifier hs-var">Diff.getTip</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025925"><span class="hs-identifier hs-var">candidate</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; Point (Header blk)
forall b. HasHeader b =&gt; ChainDiff b -&gt; Point b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getTip"><span class="hs-identifier hs-var">Diff.getTip</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025917"><span class="hs-identifier hs-var">candidate'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-815"></span><span>          </span><span class="annot"><span class="annottext">Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a. a -&gt; Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025918"><span class="hs-identifier hs-var">validatedCandidate</span></a></span><span>
</span><span id="line-816"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidPrefix"><span class="hs-identifier hs-type">ValidPrefix</span></a></span><span> </span><span id="local-6989586621680025914"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025914"><span class="hs-identifier hs-var">candidate'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-817"></span><span>          </span><span class="hs-comment">-- Prefix of the candidate because it contained rejected blocks</span><span>
</span><span id="line-818"></span><span>          </span><span class="hs-comment">-- (invalid blocks and/or blocks from the future). Note that the</span><span>
</span><span id="line-819"></span><span>          </span><span class="hs-comment">-- spec says go back to candidate selection, see [^whyGoBack],</span><span>
</span><span id="line-820"></span><span>          </span><span class="hs-comment">-- because there might still be some candidates that contain the</span><span>
</span><span id="line-821"></span><span>          </span><span class="hs-comment">-- same rejected block. To simplify the control flow, we do it</span><span>
</span><span id="line-822"></span><span>          </span><span class="hs-comment">-- differently: instead of recomputing the candidates taking</span><span>
</span><span id="line-823"></span><span>          </span><span class="hs-comment">-- rejected blocks into account, we just truncate the remaining</span><span>
</span><span id="line-824"></span><span>          </span><span class="hs-comment">-- candidates that contain rejected blocks.</span><span>
</span><span id="line-825"></span><span>          </span><span id="local-6989586621680025913"><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025913"><span class="hs-identifier hs-var">candidates1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
</span><a href="#local-6989586621680025920"><span class="hs-identifier hs-var">truncateRejectedBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025924"><span class="hs-identifier hs-var">candidates0</span></a></span><span>
</span><span id="line-826"></span><span>          </span><span class="hs-comment">-- Only include the prefix if it is still preferred over the current</span><span>
</span><span id="line-827"></span><span>          </span><span class="hs-comment">-- chain. When the candidate is now empty because of the truncation,</span><span>
</span><span id="line-828"></span><span>          </span><span class="hs-comment">-- it will be dropped here, as it will not be preferred over the</span><span>
</span><span id="line-829"></span><span>          </span><span class="hs-comment">-- current chain.</span><span>
</span><span id="line-830"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680025912"><span class="annot"><span class="annottext">candidates2 :: [ChainDiff (Header blk)]
</span><a href="#local-6989586621680025912"><span class="hs-identifier hs-var hs-var">candidates2</span></a></span></span><span>
</span><span id="line-831"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621680025933"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025932"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var hs-var">Diff.getSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025914"><span class="hs-identifier hs-var">candidate'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-832"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025914"><span class="hs-identifier hs-var">candidate'</span></a></span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025913"><span class="hs-identifier hs-var">candidates1</span></a></span><span>
</span><span id="line-833"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-834"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025913"><span class="hs-identifier hs-var">candidates1</span></a></span><span>
</span><span id="line-835"></span><span>          </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621680025931"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
</span><a href="#local-6989586621680025930"><span class="hs-identifier hs-var">sortCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025912"><span class="hs-identifier hs-var">candidates2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-836"></span><span>
</span><span id="line-837"></span><span>    </span><span class="hs-comment">-- | Truncate the given (remaining) candidates that contain rejected</span><span>
</span><span id="line-838"></span><span>    </span><span class="hs-comment">-- blocks. Discard them if they are truncated so much that they are no</span><span>
</span><span id="line-839"></span><span>    </span><span class="hs-comment">-- longer preferred over the current chain.</span><span>
</span><span id="line-840"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-841"></span><span>    </span><span class="hs-comment">-- A block is rejected if:</span><span>
</span><span id="line-842"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-843"></span><span>    </span><span class="hs-comment">-- * It is invalid (present in 'varInvalid', i.e., 'cdbInvalid').</span><span>
</span><span id="line-844"></span><span>    </span><span class="hs-comment">-- * It is from the future (present in 'varFutureBlocks', i.e.,</span><span>
</span><span id="line-845"></span><span>    </span><span class="hs-comment">--   'cdbFutureBlocks').</span><span>
</span><span id="line-846"></span><span>    </span><span class="annot"><a href="#local-6989586621680025920"><span class="hs-identifier hs-type">truncateRejectedBlocks</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-847"></span><span>         </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-848"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026600"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026599"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-849"></span><span>    </span><span id="local-6989586621680025920"><span class="annot"><span class="annottext">truncateRejectedBlocks :: [ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
</span><a href="#local-6989586621680025920"><span class="hs-identifier hs-var hs-var">truncateRejectedBlocks</span></a></span></span><span> </span><span id="local-6989586621680025911"><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025911"><span class="hs-identifier hs-var">cands</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-850"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621680025910"><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk)
</span><a href="#local-6989586621680025910"><span class="hs-identifier hs-var">invalid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025909"><span class="annot"><span class="annottext">FutureBlocks blk
</span><a href="#local-6989586621680025909"><span class="hs-identifier hs-var">futureBlocks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-851"></span><span>        </span><span class="annot"><span class="annottext">STM m (WithFingerprint (InvalidBlocks blk), FutureBlocks blk)
-&gt; m (WithFingerprint (InvalidBlocks blk), FutureBlocks blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (WithFingerprint (InvalidBlocks blk), FutureBlocks blk)
 -&gt; m (WithFingerprint (InvalidBlocks blk), FutureBlocks blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk), FutureBlocks blk)
-&gt; m (WithFingerprint (InvalidBlocks blk), FutureBlocks blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WithFingerprint (InvalidBlocks blk)
 -&gt; FutureBlocks blk
 -&gt; (WithFingerprint (InvalidBlocks blk), FutureBlocks blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
-&gt; STM
     m
     (FutureBlocks blk
      -&gt; (WithFingerprint (InvalidBlocks blk), FutureBlocks blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680025928"><span class="hs-identifier hs-var">varInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  m
  (FutureBlocks blk
   -&gt; (WithFingerprint (InvalidBlocks blk), FutureBlocks blk))
-&gt; STM m (FutureBlocks blk)
-&gt; STM m (WithFingerprint (InvalidBlocks blk), FutureBlocks blk)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks blk) -&gt; STM m (FutureBlocks blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks blk)
</span><a href="#local-6989586621680025927"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span><span>
</span><span id="line-852"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680025908"><span class="annot"><span class="annottext">isRejected :: Header blk -&gt; Bool
</span><a href="#local-6989586621680025908"><span class="hs-identifier hs-var hs-var">isRejected</span></a></span></span><span> </span><span id="local-6989586621680025907"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025907"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-853"></span><span>               </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; InvalidBlocks blk -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025907"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var hs-var">forgetFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk)
</span><a href="#local-6989586621680025910"><span class="hs-identifier hs-var">invalid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-854"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; FutureBlocks blk -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025907"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FutureBlocks blk
</span><a href="#local-6989586621680025909"><span class="hs-identifier hs-var">futureBlocks</span></a></span><span>
</span><span id="line-855"></span><span>      </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">([ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)])
-&gt; [ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; Bool)
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621680025933"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025932"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; (ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var hs-var">Diff.getSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-856"></span><span>             </span><span class="annot"><span class="annottext">([ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)])
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; ChainDiff (Header blk))
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Header blk -&gt; Bool)
-&gt; ChainDiff (Header blk) -&gt; ChainDiff (Header blk)
forall b. HasHeader b =&gt; (b -&gt; Bool) -&gt; ChainDiff b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#takeWhileOldest"><span class="hs-identifier hs-var">Diff.takeWhileOldest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Header blk -&gt; Bool) -&gt; Header blk -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Bool
</span><a href="#local-6989586621680025908"><span class="hs-identifier hs-var">isRejected</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621680025911"><span class="hs-identifier hs-var">cands</span></a></span><span>
</span><span id="line-857"></span><span>
</span><span id="line-858"></span><span>    </span><span class="hs-comment">-- [Ouroboros]</span><span>
</span><span id="line-859"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-860"></span><span>    </span><span class="hs-comment">-- Ouroboros says that when we are given an invalid chain by a peer, we</span><span>
</span><span id="line-861"></span><span>    </span><span class="hs-comment">-- should reject that peer's chain. However, since we're throwing all</span><span>
</span><span id="line-862"></span><span>    </span><span class="hs-comment">-- blocks together in the ChainDB, we can't tell which block or which</span><span>
</span><span id="line-863"></span><span>    </span><span class="hs-comment">-- chain came from which peer, so we can't simply reject a peer's chain.</span><span>
</span><span id="line-864"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-865"></span><span>    </span><span class="hs-comment">-- It might be that a good peer gave us a valid chain, but another peer</span><span>
</span><span id="line-866"></span><span>    </span><span class="hs-comment">-- gave us an invalid block that fits onto the chain of the good peer. In</span><span>
</span><span id="line-867"></span><span>    </span><span class="hs-comment">-- that case, we do still want to adopt the chain of the good peer, which</span><span>
</span><span id="line-868"></span><span>    </span><span class="hs-comment">-- is a prefix of the chain that we constructed using all the blocks we</span><span>
</span><span id="line-869"></span><span>    </span><span class="hs-comment">-- found in the VolatileDB, including the invalid block.</span><span>
</span><span id="line-870"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-871"></span><span>    </span><span class="hs-comment">-- This is the reason why we still take valid prefixes of a invalid chains</span><span>
</span><span id="line-872"></span><span>    </span><span class="hs-comment">-- into account during chain selection: they might correspond to the good</span><span>
</span><span id="line-873"></span><span>    </span><span class="hs-comment">-- peer's valid chain.</span><span>
</span><span id="line-874"></span><span>
</span><span id="line-875"></span><span class="hs-comment">-- | Result of 'validateCandidate'.</span><span>
</span><span id="line-876"></span><span class="hs-keyword">data</span><span> </span><span id="ValidationResult"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidationResult"><span class="hs-identifier hs-var">ValidationResult</span></a></span></span><span> </span><span id="local-6989586621680026329"><span class="annot"><a href="#local-6989586621680026329"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-877"></span><span>      </span><span class="hs-comment">-- | The entire candidate fragment was valid. No blocks were from the</span><span>
</span><span id="line-878"></span><span>      </span><span class="hs-comment">-- future.</span><span>
</span><span id="line-879"></span><span>      </span><span id="FullyValid"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#FullyValid"><span class="hs-identifier hs-var">FullyValid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026329"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026329"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-880"></span><span>
</span><span id="line-881"></span><span>      </span><span class="hs-comment">-- | The candidate fragment contained invalid blocks and/or blocks from</span><span>
</span><span id="line-882"></span><span>      </span><span class="hs-comment">-- the future that had to be truncated from the fragment.</span><span>
</span><span id="line-883"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ValidPrefix"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidPrefix"><span class="hs-identifier hs-var">ValidPrefix</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026329"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-884"></span><span>
</span><span id="line-885"></span><span>      </span><span class="hs-comment">-- | After truncating the invalid blocks or blocks from the future from</span><span>
</span><span id="line-886"></span><span>      </span><span class="hs-comment">-- the 'ChainDiff', it no longer contains enough blocks in its suffix to</span><span>
</span><span id="line-887"></span><span>      </span><span class="hs-comment">-- compensate for the number of blocks it wants to roll back.</span><span>
</span><span id="line-888"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InsufficientSuffix"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#InsufficientSuffix"><span class="hs-identifier hs-var">InsufficientSuffix</span></a></span></span><span>
</span><span id="line-889"></span><span>
</span><span id="line-890"></span><span class="hs-comment">-- | Validate a candidate by applying its blocks to the ledger, and return a</span><span>
</span><span id="line-891"></span><span class="hs-comment">-- 'ValidatedChainDiff' for it, i.e., a chain diff along with a ledger</span><span>
</span><span id="line-892"></span><span class="hs-comment">-- corresponding to its tip (the most recent block).</span><span>
</span><span id="line-893"></span><span class="hs-comment">--</span><span>
</span><span id="line-894"></span><span class="hs-comment">-- PRECONDITION: the candidate (chain diff) must fit onto the given current</span><span>
</span><span id="line-895"></span><span class="hs-comment">-- chain.</span><span>
</span><span id="line-896"></span><span class="hs-comment">--</span><span>
</span><span id="line-897"></span><span class="hs-comment">-- If all blocks in the fragment are valid, then the chain diff in the</span><span>
</span><span id="line-898"></span><span class="hs-comment">-- returned 'ValidatedChainDiff' is the same as the given candidate chain</span><span>
</span><span id="line-899"></span><span class="hs-comment">-- diff.</span><span>
</span><span id="line-900"></span><span class="hs-comment">--</span><span>
</span><span id="line-901"></span><span class="hs-comment">-- If a block in the fragment is invalid, then the fragment in the returned</span><span>
</span><span id="line-902"></span><span class="hs-comment">-- 'ValidatedChainDiff' is a prefix of the given candidate chain diff (upto</span><span>
</span><span id="line-903"></span><span class="hs-comment">-- the last valid block).</span><span>
</span><span id="line-904"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ledgerValidateCandidate"><span class="hs-identifier hs-type">ledgerValidateCandidate</span></a></span><span>
</span><span id="line-905"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680026333"><span class="annot"><a href="#local-6989586621680026333"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680026332"><span class="annot"><a href="#local-6989586621680026332"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-906"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026333"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-907"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026332"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-908"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-909"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-910"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026333"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026332"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-911"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026332"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-912"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026333"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026332"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026332"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span id="ledgerValidateCandidate"><span class="annot"><span class="annottext">ledgerValidateCandidate :: ChainSelEnv m blk
-&gt; ChainDiff (Header blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ledgerValidateCandidate"><span class="hs-identifier hs-var hs-var">ledgerValidateCandidate</span></a></span></span><span> </span><span id="local-6989586621680025902"><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680025902"><span class="hs-identifier hs-var">chainSelEnv</span></a></span></span><span> </span><span id="local-6989586621680025901"><span class="annot"><span class="annottext">chainDiff :: ChainDiff (Header blk)
</span><a href="#local-6989586621680025901"><span class="hs-identifier hs-var">chainDiff</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span id="local-6989586621680025900"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680025900"><span class="hs-identifier hs-var">rollback</span></a></span></span><span> </span><span id="local-6989586621680025899"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025899"><span class="hs-identifier hs-var">suffix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-914"></span><span>    </span><span class="annot"><span class="annottext">LgrDB m blk
-&gt; LedgerDB' blk
-&gt; BlockCache blk
-&gt; Word64
-&gt; (UpdateLedgerDbTraceEvent blk -&gt; m ())
-&gt; [Header blk]
-&gt; m (ValidateResult blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
LgrDB m blk
-&gt; LedgerDB' blk
-&gt; BlockCache blk
-&gt; Word64
-&gt; (UpdateLedgerDbTraceEvent blk -&gt; m ())
-&gt; [Header blk]
-&gt; m (ValidateResult blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#validate"><span class="hs-identifier hs-var">LgrDB.validate</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680025897"><span class="hs-identifier hs-var">lgrDB</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025896"><span class="hs-identifier hs-var">curLedger</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621680025895"><span class="hs-identifier hs-var">blockCache</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680025900"><span class="hs-identifier hs-var">rollback</span></a></span><span> </span><span class="annot"><span class="annottext">UpdateLedgerDbTraceEvent blk -&gt; m ()
</span><a href="#local-6989586621680025894"><span class="hs-identifier hs-var">traceUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621680025893"><span class="hs-identifier hs-var">newBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">m (ValidateResult blk)
-&gt; (ValidateResult blk
    -&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-915"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#ValidateExceededRollBack"><span class="hs-identifier hs-type">LgrDB.ValidateExceededRollBack</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-916"></span><span>        </span><span class="hs-comment">-- Impossible: we asked the LgrDB to roll back past the immutable tip,</span><span>
</span><span id="line-917"></span><span>        </span><span class="hs-comment">-- which is impossible, since the candidates we construct must connect</span><span>
</span><span id="line-918"></span><span>        </span><span class="hs-comment">-- to the immutable tip.</span><span>
</span><span id="line-919"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;found candidate requiring rolling back past the immutable tip&quot;</span></span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#ValidateLedgerError"><span class="hs-identifier hs-type">LgrDB.ValidateLedgerError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.InMemory.html#AnnLedgerError"><span class="hs-identifier hs-type">LgrDB.AnnLedgerError</span></a></span><span> </span><span id="local-6989586621680025889"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025889"><span class="hs-identifier hs-var">ledger'</span></a></span></span><span> </span><span id="local-6989586621680025888"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680025888"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621680025887"><span class="annot"><span class="annottext">LedgerErr (ExtLedgerState blk)
</span><a href="#local-6989586621680025887"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-922"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680025886"><span class="annot"><span class="annottext">lastValid :: Point blk
</span><a href="#local-6989586621680025886"><span class="hs-identifier hs-var hs-var">lastValid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; Point blk
forall blk. UpdateLedger blk =&gt; LedgerDB' blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#currentPoint"><span class="hs-identifier hs-var">LgrDB.currentPoint</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025889"><span class="hs-identifier hs-var">ledger'</span></a></span><span>
</span><span id="line-923"></span><span>            </span><span id="local-6989586621680025885"><span class="annot"><span class="annottext">chainDiff' :: ChainDiff (Header blk)
</span><a href="#local-6989586621680025885"><span class="hs-identifier hs-var hs-var">chainDiff'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
-&gt; ChainDiff (Header blk) -&gt; ChainDiff (Header blk)
forall b.
(HasHeader b, HasCallStack) =&gt;
Point b -&gt; ChainDiff b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#truncate"><span class="hs-identifier hs-var">Diff.truncate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point (Header blk)
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680025886"><span class="hs-identifier hs-var">lastValid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025901"><span class="hs-identifier hs-var">chainDiff</span></a></span><span>
</span><span id="line-924"></span><span>        </span><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; m ()
</span><a href="#local-6989586621680025883"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtValidationError blk -&gt; RealPoint blk -&gt; TraceValidationEvent blk
forall blk.
ExtValidationError blk -&gt; RealPoint blk -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlock"><span class="hs-identifier hs-var">InvalidBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerErr (ExtLedgerState blk)
ExtValidationError blk
</span><a href="#local-6989586621680025887"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680025888"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-925"></span><span>        </span><span class="annot"><span class="annottext">ExtValidationError blk -&gt; RealPoint blk -&gt; m ()
</span><a href="#local-6989586621680025881"><span class="hs-identifier hs-var">addInvalidBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerErr (ExtLedgerState blk)
ExtValidationError blk
</span><a href="#local-6989586621680025887"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680025888"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-926"></span><span>        </span><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; m ()
</span><a href="#local-6989586621680025883"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; TraceValidationEvent blk
forall blk.
AnchoredFragment (Header blk) -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ValidCandidate"><span class="hs-identifier hs-var">ValidCandidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var hs-var">Diff.getSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025885"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-927"></span><span>        </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidatedChainDiff (Header blk) (LedgerDB' blk)
 -&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; LedgerDB' blk -&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
forall b l.
(IsLedger l, HasHeader b, HeaderHash l ~ HeaderHash b,
 HasCallStack) =&gt;
ChainDiff b -&gt; l -&gt; ValidatedChainDiff b l
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#new"><span class="hs-identifier hs-var">ValidatedDiff.new</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025885"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025889"><span class="hs-identifier hs-var">ledger'</span></a></span><span>
</span><span id="line-928"></span><span>
</span><span id="line-929"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#ValidateSuccessful"><span class="hs-identifier hs-type">LgrDB.ValidateSuccessful</span></a></span><span> </span><span id="local-6989586621680025877"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025877"><span class="hs-identifier hs-var">ledger'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-930"></span><span>        </span><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; m ()
</span><a href="#local-6989586621680025883"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; TraceValidationEvent blk
forall blk.
AnchoredFragment (Header blk) -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ValidCandidate"><span class="hs-identifier hs-var">ValidCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025899"><span class="hs-identifier hs-var">suffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-931"></span><span>        </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidatedChainDiff (Header blk) (LedgerDB' blk)
 -&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; LedgerDB' blk -&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
forall b l.
(IsLedger l, HasHeader b, HeaderHash l ~ HeaderHash b,
 HasCallStack) =&gt;
ChainDiff b -&gt; l -&gt; ValidatedChainDiff b l
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#new"><span class="hs-identifier hs-var">ValidatedDiff.new</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025901"><span class="hs-identifier hs-var">chainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621680025877"><span class="hs-identifier hs-var">ledger'</span></a></span><span>
</span><span id="line-932"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-933"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680025897"><span class="annot"><span class="annottext">LgrDB m blk
lgrDB :: LgrDB m blk
lgrDB :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; LgrDB m blk
</span><a href="#local-6989586621680025897"><span class="hs-identifier hs-var hs-var">lgrDB</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025883"><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; m ()
trace :: TraceValidationEvent blk -&gt; m ()
trace :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; TraceValidationEvent blk -&gt; m ()
</span><a href="#local-6989586621680025883"><span class="hs-identifier hs-var hs-var">trace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025876"><span class="annot"><span class="annottext">ChainAndLedger blk
curChainAndLedger :: ChainAndLedger blk
curChainAndLedger :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; ChainAndLedger blk
</span><a href="#local-6989586621680025876"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025895"><span class="annot"><span class="annottext">BlockCache blk
blockCache :: BlockCache blk
blockCache :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockCache blk
</span><a href="#local-6989586621680025895"><span class="hs-identifier hs-var hs-var">blockCache</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025875"><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680025875"><span class="hs-identifier hs-var hs-var">varInvalid</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-934"></span><span>      </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680025902"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span>
</span><span id="line-935"></span><span>
</span><span id="line-936"></span><span>    </span><span id="local-6989586621680025894"><span class="annot"><span class="annottext">traceUpdate :: UpdateLedgerDbTraceEvent blk -&gt; m ()
</span><a href="#local-6989586621680025894"><span class="hs-identifier hs-var hs-var">traceUpdate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; m ()
</span><a href="#local-6989586621680025883"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceValidationEvent blk -&gt; m ())
-&gt; (UpdateLedgerDbTraceEvent blk -&gt; TraceValidationEvent blk)
-&gt; UpdateLedgerDbTraceEvent blk
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">UpdateLedgerDbTraceEvent blk -&gt; TraceValidationEvent blk
forall blk.
UpdateLedgerDbTraceEvent blk -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#UpdateLedgerDbTraceEvent"><span class="hs-identifier hs-var">UpdateLedgerDbTraceEvent</span></a></span><span>
</span><span id="line-937"></span><span>
</span><span id="line-938"></span><span>    </span><span class="annot"><a href="#local-6989586621680025896"><span class="hs-identifier hs-type">curLedger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026332"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-939"></span><span>    </span><span id="local-6989586621680025896"><span class="annot"><span class="annottext">curLedger :: LedgerDB' blk
</span><a href="#local-6989586621680025896"><span class="hs-identifier hs-var hs-var">curLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; LedgerDB' blk
forall b l. ValidatedFragment b l -&gt; l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedLedger"><span class="hs-identifier hs-var hs-var">VF.validatedLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621680025876"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-940"></span><span>
</span><span id="line-941"></span><span>    </span><span class="annot"><a href="#local-6989586621680025893"><span class="hs-identifier hs-type">newBlocks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026332"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-942"></span><span>    </span><span id="local-6989586621680025893"><span class="annot"><span class="annottext">newBlocks :: [Header blk]
</span><a href="#local-6989586621680025893"><span class="hs-identifier hs-var hs-var">newBlocks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; [Header blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.toOldestFirst</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025899"><span class="hs-identifier hs-var">suffix</span></a></span><span>
</span><span id="line-943"></span><span>
</span><span id="line-944"></span><span>    </span><span class="hs-comment">-- | Record the invalid block in 'cdbInvalid' and change its fingerprint.</span><span>
</span><span id="line-945"></span><span>    </span><span class="annot"><a href="#local-6989586621680025881"><span class="hs-identifier hs-type">addInvalidBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtValidationError"><span class="hs-identifier hs-type">ExtValidationError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026332"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026332"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026333"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-946"></span><span>    </span><span id="local-6989586621680025881"><span class="annot"><span class="annottext">addInvalidBlock :: ExtValidationError blk -&gt; RealPoint blk -&gt; m ()
</span><a href="#local-6989586621680025881"><span class="hs-identifier hs-var hs-var">addInvalidBlock</span></a></span></span><span> </span><span id="local-6989586621680025872"><span class="annot"><span class="annottext">ExtValidationError blk
</span><a href="#local-6989586621680025872"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span id="local-6989586621680025870"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680025870"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span id="local-6989586621680025869"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680025869"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-947"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; (WithFingerprint (InvalidBlocks blk)
    -&gt; WithFingerprint (InvalidBlocks blk))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680025875"><span class="hs-identifier hs-var">varInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">((WithFingerprint (InvalidBlocks blk)
  -&gt; WithFingerprint (InvalidBlocks blk))
 -&gt; STM m ())
-&gt; (WithFingerprint (InvalidBlocks blk)
    -&gt; WithFingerprint (InvalidBlocks blk))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span id="local-6989586621680025866"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680025866"><span class="hs-identifier hs-var">invalid</span></a></span></span><span> </span><span id="local-6989586621680025865"><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621680025865"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-948"></span><span>        </span><span class="annot"><span class="annottext">InvalidBlocks blk
-&gt; Fingerprint -&gt; WithFingerprint (InvalidBlocks blk)
forall a. a -&gt; Fingerprint -&gt; WithFingerprint a
</span><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-var">WithFingerprint</span></a></span><span>
</span><span id="line-949"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk
-&gt; InvalidBlockInfo blk -&gt; InvalidBlocks blk -&gt; InvalidBlocks blk
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680025869"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InvalidBlockReason blk -&gt; SlotNo -&gt; InvalidBlockInfo blk
forall blk.
InvalidBlockReason blk -&gt; SlotNo -&gt; InvalidBlockInfo blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlockInfo"><span class="hs-identifier hs-var">InvalidBlockInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtValidationError blk -&gt; InvalidBlockReason blk
forall blk. ExtValidationError blk -&gt; InvalidBlockReason blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ValidationError"><span class="hs-identifier hs-var">ValidationError</span></a></span><span> </span><span class="annot"><span class="annottext">ExtValidationError blk
</span><a href="#local-6989586621680025872"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680025870"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680025866"><span class="hs-identifier hs-var">invalid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-950"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fingerprint -&gt; Fingerprint
forall a. Enum a =&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621680025865"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-951"></span><span>
</span><span id="line-952"></span><span class="hs-comment">-- | Truncate any future headers from the candidate 'ValidatedChainDiff'.</span><span>
</span><span id="line-953"></span><span class="hs-comment">--</span><span>
</span><span id="line-954"></span><span class="hs-comment">-- Future headers that don't exceed the clock skew</span><span>
</span><span id="line-955"></span><span class="hs-comment">-- ('inFutureExceedsClockSkew') are added to 'cdbFutureBlocks'.</span><span>
</span><span id="line-956"></span><span class="hs-comment">--</span><span>
</span><span id="line-957"></span><span class="hs-comment">-- Future headers that exceed the clock skew are added to 'cdbInvalid' with</span><span>
</span><span id="line-958"></span><span class="hs-comment">-- 'InFutureExceedsClockSkew' as the reason.</span><span>
</span><span id="line-959"></span><span class="hs-comment">--</span><span>
</span><span id="line-960"></span><span class="hs-comment">-- When truncation happened, 'Left' is returned, otherwise 'Right'.</span><span>
</span><span id="line-961"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheckCandidate"><span class="hs-identifier hs-type">futureCheckCandidate</span></a></span><span>
</span><span id="line-962"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680026328"><span class="annot"><a href="#local-6989586621680026328"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680026327"><span class="annot"><a href="#local-6989586621680026327"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026328"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026327"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-963"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026328"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026327"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-964"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026327"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026327"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-965"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026328"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026327"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-966"></span><span>               </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026327"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026327"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-967"></span><span id="futureCheckCandidate"><span class="annot"><span class="annottext">futureCheckCandidate :: ChainSelEnv m blk
-&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheckCandidate"><span class="hs-identifier hs-var hs-var">futureCheckCandidate</span></a></span></span><span> </span><span id="local-6989586621680025861"><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680025861"><span class="hs-identifier hs-var">chainSelEnv</span></a></span></span><span> </span><span id="local-6989586621680025860"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025860"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-968"></span><span>    </span><span class="annot"><span class="annottext">CheckInFuture m blk
-&gt; ValidatedFragment (Header blk) (LedgerState blk)
-&gt; m (AnchoredFragment (Header blk), [InFuture blk])
forall (m :: * -&gt; *) blk.
CheckInFuture m blk
-&gt; ValidatedFragment (Header blk) (LedgerState blk)
-&gt; m (AnchoredFragment (Header blk), [InFuture blk])
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#checkInFuture"><span class="hs-identifier hs-var hs-var">checkInFuture</span></a></span><span> </span><span class="annot"><span class="annottext">CheckInFuture m blk
</span><a href="#local-6989586621680025858"><span class="hs-identifier hs-var">futureCheck</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedFragment (Header blk) (LedgerState blk)
</span><a href="#local-6989586621680025857"><span class="hs-identifier hs-var">validatedSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">m (AnchoredFragment (Header blk), [InFuture blk])
-&gt; ((AnchoredFragment (Header blk), [InFuture blk])
    -&gt; m (Either
            (ChainDiff (Header blk))
            (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-969"></span><span>
</span><span id="line-970"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621680025856"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025856"><span class="hs-identifier hs-var">suffix'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-971"></span><span>        </span><span class="hs-comment">-- If no headers are in the future, then the fragment must be untouched</span><span>
</span><span id="line-972"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025855"><span class="hs-identifier hs-var">suffix</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025856"><span class="hs-identifier hs-var">suffix'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Either
      (ChainDiff (Header blk))
      (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Either
         (ChainDiff (Header blk))
         (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-973"></span><span>        </span><span class="annot"><span class="annottext">Either
  (ChainDiff (Header blk))
  (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (ChainDiff (Header blk))
   (ValidatedChainDiff (Header blk) (LedgerDB' blk))
 -&gt; m (Either
         (ChainDiff (Header blk))
         (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a b. b -&gt; Either a b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025860"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span>
</span><span id="line-974"></span><span>
</span><span id="line-975"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621680025854"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025854"><span class="hs-identifier hs-var">suffix'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025853"><span class="annot"><span class="annottext">[InFuture blk]
</span><a href="#local-6989586621680025853"><span class="hs-identifier hs-var">inFuture</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-976"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680025852"><span class="annot"><span class="annottext">[InFuture blk]
</span><a href="#local-6989586621680025852"><span class="hs-identifier hs-var">exceedClockSkew</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025851"><span class="annot"><span class="annottext">[InFuture blk]
</span><a href="#local-6989586621680025851"><span class="hs-identifier hs-var">inNearFuture</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-977"></span><span>              </span><span class="annot"><span class="annottext">(InFuture blk -&gt; Bool)
-&gt; [InFuture blk] -&gt; ([InFuture blk], [InFuture blk])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">partition</span></a></span><span> </span><span class="annot"><span class="annottext">InFuture blk -&gt; Bool
forall blk. InFuture blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#inFutureExceedsClockSkew"><span class="hs-identifier hs-var hs-var">InFuture.inFutureExceedsClockSkew</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture blk]
</span><a href="#local-6989586621680025853"><span class="hs-identifier hs-var">inFuture</span></a></span><span>
</span><span id="line-978"></span><span>        </span><span class="hs-comment">-- Record future blocks</span><span>
</span><span id="line-979"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InFuture blk] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture blk]
</span><a href="#local-6989586621680025851"><span class="hs-identifier hs-var">inNearFuture</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-980"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680025847"><span class="annot"><span class="annottext">futureHeaders :: [Header blk]
</span><a href="#local-6989586621680025847"><span class="hs-identifier hs-var hs-var">futureHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InFuture blk -&gt; Header blk
forall blk. InFuture blk -&gt; Header blk
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#inFutureHeader"><span class="hs-identifier hs-var hs-var">InFuture.inFutureHeader</span></a></span><span> </span><span class="annot"><span class="annottext">(InFuture blk -&gt; Header blk) -&gt; [InFuture blk] -&gt; [Header blk]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture blk]
</span><a href="#local-6989586621680025851"><span class="hs-identifier hs-var">inNearFuture</span></a></span><span>
</span><span id="line-981"></span><span>              </span><span id="local-6989586621680025845"><span class="annot"><span class="annottext">futureBlocks :: Map (HeaderHash blk) (Header blk)
</span><a href="#local-6989586621680025845"><span class="hs-identifier hs-var hs-var">futureBlocks</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(HeaderHash blk, Header blk)] -&gt; Map (HeaderHash blk) (Header blk)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span>
</span><span id="line-982"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025843"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025843"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621680025843"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025843"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621680025847"><span class="hs-identifier hs-var">futureHeaders</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-983"></span><span>          </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map (HeaderHash blk) (Header blk))
-&gt; (Map (HeaderHash blk) (Header blk)
    -&gt; Map (HeaderHash blk) (Header blk))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map (HeaderHash blk) (Header blk))
</span><a href="#local-6989586621680025842"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">((Map (HeaderHash blk) (Header blk)
  -&gt; Map (HeaderHash blk) (Header blk))
 -&gt; STM m ())
-&gt; (Map (HeaderHash blk) (Header blk)
    -&gt; Map (HeaderHash blk) (Header blk))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Map (HeaderHash blk) (Header blk)
 -&gt; Map (HeaderHash blk) (Header blk)
 -&gt; Map (HeaderHash blk) (Header blk))
-&gt; Map (HeaderHash blk) (Header blk)
-&gt; Map (HeaderHash blk) (Header blk)
-&gt; Map (HeaderHash blk) (Header blk)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (Header blk)
-&gt; Map (HeaderHash blk) (Header blk)
-&gt; Map (HeaderHash blk) (Header blk)
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.union</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (Header blk)
</span><a href="#local-6989586621680025845"><span class="hs-identifier hs-var">futureBlocks</span></a></span><span>
</span><span id="line-984"></span><span>          </span><span class="hs-comment">-- Trace the original @suffix@, as it contains the headers from the</span><span>
</span><span id="line-985"></span><span>          </span><span class="hs-comment">-- future</span><span>
</span><span id="line-986"></span><span>          </span><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; m ()
</span><a href="#local-6989586621680025840"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceValidationEvent blk -&gt; m ())
-&gt; TraceValidationEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; [Header blk] -&gt; TraceValidationEvent blk
forall blk.
AnchoredFragment (Header blk)
-&gt; [Header blk] -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CandidateContainsFutureBlocks"><span class="hs-identifier hs-var">CandidateContainsFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025855"><span class="hs-identifier hs-var">suffix</span></a></span><span> </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621680025847"><span class="hs-identifier hs-var">futureHeaders</span></a></span><span>
</span><span id="line-987"></span><span>
</span><span id="line-988"></span><span>        </span><span class="hs-comment">-- Record any blocks exceeding the clock skew as invalid</span><span>
</span><span id="line-989"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InFuture blk] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture blk]
</span><a href="#local-6989586621680025852"><span class="hs-identifier hs-var">exceedClockSkew</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-990"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680025838"><span class="annot"><span class="annottext">invalidHeaders :: [Header blk]
</span><a href="#local-6989586621680025838"><span class="hs-identifier hs-var hs-var">invalidHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InFuture blk -&gt; Header blk
forall blk. InFuture blk -&gt; Header blk
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#inFutureHeader"><span class="hs-identifier hs-var hs-var">InFuture.inFutureHeader</span></a></span><span> </span><span class="annot"><span class="annottext">(InFuture blk -&gt; Header blk) -&gt; [InFuture blk] -&gt; [Header blk]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture blk]
</span><a href="#local-6989586621680025852"><span class="hs-identifier hs-var">exceedClockSkew</span></a></span><span>
</span><span id="line-991"></span><span>              </span><span id="local-6989586621680025837"><span class="annot"><span class="annottext">invalidBlocks :: Map (HeaderHash blk) (InvalidBlockInfo blk)
</span><a href="#local-6989586621680025837"><span class="hs-identifier hs-var hs-var">invalidBlocks</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(HeaderHash blk, InvalidBlockInfo blk)]
-&gt; Map (HeaderHash blk) (InvalidBlockInfo blk)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span>
</span><span id="line-992"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025836"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InvalidBlockInfo blk
</span><a href="#local-6989586621680025835"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-993"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621680025836"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025836"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621680025838"><span class="hs-identifier hs-var">invalidHeaders</span></a></span><span>
</span><span id="line-994"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680025834"><span class="annot"><span class="annottext">reason :: InvalidBlockReason blk
</span><a href="#local-6989586621680025834"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; InvalidBlockReason blk
forall blk. RealPoint blk -&gt; InvalidBlockReason blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InFutureExceedsClockSkew"><span class="hs-identifier hs-var">InFutureExceedsClockSkew</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; RealPoint blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#headerRealPoint"><span class="hs-identifier hs-var">headerRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025836"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-995"></span><span>                      </span><span id="local-6989586621680025835"><span class="annot"><span class="annottext">info :: InvalidBlockInfo blk
</span><a href="#local-6989586621680025835"><span class="hs-identifier hs-var hs-var">info</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk -&gt; SlotNo -&gt; InvalidBlockInfo blk
forall blk.
InvalidBlockReason blk -&gt; SlotNo -&gt; InvalidBlockInfo blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlockInfo"><span class="hs-identifier hs-var">InvalidBlockInfo</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680025834"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; SlotNo
forall b. HasHeader b =&gt; b -&gt; SlotNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680025836"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-996"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-997"></span><span>          </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
-&gt; (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))
    -&gt; WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
</span><a href="#local-6989586621680025831"><span class="hs-identifier hs-var">varInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">((WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))
  -&gt; WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
 -&gt; STM m ())
-&gt; (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))
    -&gt; WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span id="local-6989586621680025830"><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
</span><a href="#local-6989586621680025830"><span class="hs-identifier hs-var">invalid</span></a></span></span><span> </span><span id="local-6989586621680025829"><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621680025829"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-998"></span><span>            </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
-&gt; Fingerprint
-&gt; WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))
forall a. a -&gt; Fingerprint -&gt; WithFingerprint a
</span><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-var">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
-&gt; Map (HeaderHash blk) (InvalidBlockInfo blk)
-&gt; Map (HeaderHash blk) (InvalidBlockInfo blk)
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.union</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
</span><a href="#local-6989586621680025830"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
</span><a href="#local-6989586621680025837"><span class="hs-identifier hs-var">invalidBlocks</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fingerprint -&gt; Fingerprint
forall a. Enum a =&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621680025829"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-999"></span><span>          </span><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; m ()
</span><a href="#local-6989586621680025840"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceValidationEvent blk -&gt; m ())
-&gt; TraceValidationEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1000"></span><span>            </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; [Header blk] -&gt; TraceValidationEvent blk
forall blk.
AnchoredFragment (Header blk)
-&gt; [Header blk] -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CandidateContainsFutureBlocksExceedingClockSkew"><span class="hs-identifier hs-var">CandidateContainsFutureBlocksExceedingClockSkew</span></a></span><span>
</span><span id="line-1001"></span><span>              </span><span class="hs-comment">-- Trace the original @suffix@, as it contains the headers</span><span>
</span><span id="line-1002"></span><span>              </span><span class="hs-comment">-- from the future</span><span>
</span><span id="line-1003"></span><span>              </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025855"><span class="hs-identifier hs-var">suffix</span></a></span><span>
</span><span id="line-1004"></span><span>              </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621680025838"><span class="hs-identifier hs-var">invalidHeaders</span></a></span><span>
</span><span id="line-1005"></span><span>
</span><span id="line-1006"></span><span>        </span><span class="hs-comment">-- Truncate the original 'ChainDiff' to match the truncated</span><span>
</span><span id="line-1007"></span><span>        </span><span class="hs-comment">-- 'AnchoredFragment'.</span><span>
</span><span id="line-1008"></span><span>        </span><span class="annot"><span class="annottext">Either
  (ChainDiff (Header blk))
  (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (ChainDiff (Header blk))
   (ValidatedChainDiff (Header blk) (LedgerDB' blk))
 -&gt; m (Either
         (ChainDiff (Header blk))
         (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a b. a -&gt; Either a b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (Header blk)
 -&gt; Either
      (ChainDiff (Header blk))
      (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; ChainDiff (Header blk)
-&gt; Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
-&gt; ChainDiff (Header blk) -&gt; ChainDiff (Header blk)
forall b.
(HasHeader b, HasCallStack) =&gt;
Point b -&gt; ChainDiff b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#truncate"><span class="hs-identifier hs-var">Diff.truncate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk)
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025854"><span class="hs-identifier hs-var">suffix'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025827"><span class="hs-identifier hs-var">chainDiff</span></a></span><span>
</span><span id="line-1009"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1010"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680025840"><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; m ()
trace :: TraceValidationEvent blk -&gt; m ()
trace :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; TraceValidationEvent blk -&gt; m ()
</span><a href="#local-6989586621680025840"><span class="hs-identifier hs-var hs-var">trace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025831"><span class="annot"><span class="annottext">StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
varInvalid :: StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
varInvalid :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680025831"><span class="hs-identifier hs-var hs-var">varInvalid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025842"><span class="annot"><span class="annottext">StrictTVar m (Map (HeaderHash blk) (Header blk))
varFutureBlocks :: StrictTVar m (Map (HeaderHash blk) (Header blk))
varFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
</span><a href="#local-6989586621680025842"><span class="hs-identifier hs-var hs-var">varFutureBlocks</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680025858"><span class="annot"><span class="annottext">CheckInFuture m blk
futureCheck :: CheckInFuture m blk
futureCheck :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; CheckInFuture m blk
</span><a href="#local-6989586621680025858"><span class="hs-identifier hs-var hs-var">futureCheck</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1011"></span><span>      </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680025861"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span>
</span><span id="line-1012"></span><span>
</span><span id="line-1013"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span id="local-6989586621680025827"><span class="annot"><span class="annottext">chainDiff :: ChainDiff (Header blk)
</span><a href="#local-6989586621680025827"><span class="hs-identifier hs-var">chainDiff</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680025855"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680025855"><span class="hs-identifier hs-var">suffix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025860"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span>
</span><span id="line-1014"></span><span>
</span><span id="line-1015"></span><span>    </span><span class="annot"><a href="#local-6989586621680025857"><span class="hs-identifier hs-type">validatedSuffix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier hs-type">ValidatedFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026327"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026327"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1016"></span><span>    </span><span id="local-6989586621680025857"><span class="annot"><span class="annottext">validatedSuffix :: ValidatedFragment (Header blk) (LedgerState blk)
</span><a href="#local-6989586621680025857"><span class="hs-identifier hs-var hs-var">validatedSuffix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1017"></span><span>      </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; LedgerState blk)
-&gt; (LedgerDB' blk -&gt; ExtLedgerState blk)
-&gt; LedgerDB' blk
-&gt; LedgerState blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; ExtLedgerState blk
forall l. GetTip l =&gt; LedgerDB l -&gt; l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.InMemory.html#ledgerDbCurrent"><span class="hs-identifier hs-var">LgrDB.ledgerDbCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">(LedgerDB' blk -&gt; LedgerState blk)
-&gt; ValidatedFragment (Header blk) (LedgerDB' blk)
-&gt; ValidatedFragment (Header blk) (LedgerState blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-1018"></span><span>      </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ValidatedFragment (Header blk) (LedgerDB' blk)
forall l b.
(IsLedger l, HasHeader b, HeaderHash l ~ HeaderHash b,
 HasCallStack) =&gt;
ValidatedChainDiff b l -&gt; ValidatedFragment b l
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#toValidatedFragment"><span class="hs-identifier hs-var">ValidatedDiff.toValidatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025860"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span>
</span><span id="line-1019"></span><span>
</span><span id="line-1020"></span><span class="hs-comment">-- | Validate a candidate chain using 'ledgerValidate' and 'futureCheck'.</span><span>
</span><span id="line-1021"></span><span id="local-6989586621680026383"><span id="local-6989586621680026384"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validateCandidate"><span class="hs-identifier hs-type">validateCandidate</span></a></span><span>
</span><span id="line-1022"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026384"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1023"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026383"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1024"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-1025"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1026"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026384"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026383"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1027"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026383"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1028"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026384"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidationResult"><span class="hs-identifier hs-type">ValidationResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026383"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1029"></span><span id="validateCandidate"><span class="annot"><span class="annottext">validateCandidate :: ChainSelEnv m blk
-&gt; ChainDiff (Header blk) -&gt; m (ValidationResult blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validateCandidate"><span class="hs-identifier hs-var hs-var">validateCandidate</span></a></span></span><span> </span><span id="local-6989586621680025825"><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680025825"><span class="hs-identifier hs-var">chainSelEnv</span></a></span></span><span> </span><span id="local-6989586621680025824"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025824"><span class="hs-identifier hs-var">chainDiff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1030"></span><span>    </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; ChainDiff (Header blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; ChainDiff (Header blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ledgerValidateCandidate"><span class="hs-identifier hs-var">ledgerValidateCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680025825"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025824"><span class="hs-identifier hs-var">chainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; (ValidatedChainDiff (Header blk) (LedgerDB' blk)
    -&gt; m (ValidationResult blk))
-&gt; m (ValidationResult blk)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1031"></span><span>      </span><span id="local-6989586621680025823"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025823"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span></span><span>
</span><span id="line-1032"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk) -&gt; Bool
forall b l. HasHeader b =&gt; ValidatedChainDiff b l -&gt; Bool
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#rollbackExceedsSuffix"><span class="hs-identifier hs-var">ValidatedDiff.rollbackExceedsSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025823"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span>
</span><span id="line-1033"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult blk
forall blk. ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#InsufficientSuffix"><span class="hs-identifier hs-var">InsufficientSuffix</span></a></span><span>
</span><span id="line-1034"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1035"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ChainSelEnv m blk
-&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheckCandidate"><span class="hs-identifier hs-var">futureCheckCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621680025825"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025823"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; (Either
      (ChainDiff (Header blk))
      (ValidatedChainDiff (Header blk) (LedgerDB' blk))
    -&gt; m (ValidationResult blk))
-&gt; m (ValidationResult blk)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1036"></span><span>          </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680025821"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025821"><span class="hs-identifier hs-var">chainDiff'</span></a></span></span><span>
</span><span id="line-1037"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; Bool
forall b. HasHeader b =&gt; ChainDiff b -&gt; Bool
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#rollbackExceedsSuffix"><span class="hs-identifier hs-var">Diff.rollbackExceedsSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025821"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span>
</span><span id="line-1038"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult blk
forall blk. ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#InsufficientSuffix"><span class="hs-identifier hs-var">InsufficientSuffix</span></a></span><span>
</span><span id="line-1039"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1040"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidationResult blk -&gt; m (ValidationResult blk))
-&gt; ValidationResult blk -&gt; m (ValidationResult blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; ValidationResult blk
forall blk. ChainDiff (Header blk) -&gt; ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidPrefix"><span class="hs-identifier hs-var">ValidPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025821"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span>
</span><span id="line-1041"></span><span>          </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680025820"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025820"><span class="hs-identifier hs-var">validatedChainDiff'</span></a></span></span><span>
</span><span id="line-1042"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk) -&gt; Bool
forall b l. HasHeader b =&gt; ValidatedChainDiff b l -&gt; Bool
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#rollbackExceedsSuffix"><span class="hs-identifier hs-var">ValidatedDiff.rollbackExceedsSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025820"><span class="hs-identifier hs-var">validatedChainDiff'</span></a></span><span>
</span><span id="line-1043"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult blk
forall blk. ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#InsufficientSuffix"><span class="hs-identifier hs-var">InsufficientSuffix</span></a></span><span>
</span><span id="line-1044"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.length</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var hs-var">Diff.getSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025824"><span class="hs-identifier hs-var">chainDiff</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span>
</span><span id="line-1045"></span><span>                </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.length</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var hs-var">Diff.getSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025819"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1046"></span><span>                </span><span class="hs-comment">-- No truncation</span><span>
</span><span id="line-1047"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidationResult blk -&gt; m (ValidationResult blk))
-&gt; ValidationResult blk -&gt; m (ValidationResult blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ValidationResult blk
forall blk.
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#FullyValid"><span class="hs-identifier hs-var">FullyValid</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025820"><span class="hs-identifier hs-var">validatedChainDiff'</span></a></span><span>
</span><span id="line-1048"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1049"></span><span>                </span><span class="hs-comment">-- In case of invalid blocks but no blocks from the future, we</span><span>
</span><span id="line-1050"></span><span>                </span><span class="hs-comment">-- throw away the ledger corresponding to the truncated</span><span>
</span><span id="line-1051"></span><span>                </span><span class="hs-comment">-- fragment and will have to validate it again, even when it's</span><span>
</span><span id="line-1052"></span><span>                </span><span class="hs-comment">-- the sole candidate.</span><span>
</span><span id="line-1053"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidationResult blk -&gt; m (ValidationResult blk))
-&gt; ValidationResult blk -&gt; m (ValidationResult blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; ValidationResult blk
forall blk. ChainDiff (Header blk) -&gt; ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidPrefix"><span class="hs-identifier hs-var">ValidPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621680025819"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span>
</span><span id="line-1054"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-1055"></span><span>              </span><span id="local-6989586621680025819"><span class="annot"><span class="annottext">chainDiff' :: ChainDiff (Header blk)
</span><a href="#local-6989586621680025819"><span class="hs-identifier hs-var hs-var">chainDiff'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ChainDiff (Header blk)
forall b l. ValidatedChainDiff b l -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#getChainDiff"><span class="hs-identifier hs-var hs-var">ValidatedDiff.getChainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621680025820"><span class="hs-identifier hs-var">validatedChainDiff'</span></a></span><span>
</span><span id="line-1056"></span><span>
</span><span id="line-1057"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  'ChainAndLedger'
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1060"></span><span>
</span><span id="line-1061"></span><span class="hs-comment">-- | Instantiate 'ValidatedFragment' in the way that chain selection requires.</span><span>
</span><span id="line-1062"></span><span class="hs-keyword">type</span><span> </span><span id="ChainAndLedger"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-var">ChainAndLedger</span></a></span></span><span> </span><span id="local-6989586621680025817"><span class="annot"><a href="#local-6989586621680025817"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier hs-type">ValidatedFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680025817"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.OnDisk.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680025817"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1063"></span><span>
</span><span id="line-1064"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Helpers
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1067"></span><span>
</span><span id="line-1068"></span><span class="hs-comment">-- | Wrap a @getter@ function so that it returns 'Nothing' for invalid blocks.</span><span>
</span><span id="line-1069"></span><span id="local-6989586621680026493"><span id="local-6989586621680026494"><span id="local-6989586621680026495"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalid"><span class="hs-identifier hs-type">ignoreInvalid</span></a></span><span>
</span><span id="line-1070"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026495"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1071"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026494"><span class="hs-identifier hs-type">proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026495"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1072"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlocks"><span class="hs-identifier hs-type">InvalidBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026495"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1073"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026495"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026493"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1074"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026495"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026493"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1075"></span><span id="ignoreInvalid"><span class="annot"><span class="annottext">ignoreInvalid :: proxy blk
-&gt; InvalidBlocks blk
-&gt; (HeaderHash blk -&gt; Maybe a)
-&gt; HeaderHash blk
-&gt; Maybe a
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalid"><span class="hs-identifier hs-var hs-var">ignoreInvalid</span></a></span></span><span> </span><span class="annot"><span class="annottext">proxy blk
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680025816"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680025816"><span class="hs-identifier hs-var">invalid</span></a></span></span><span> </span><span id="local-6989586621680025815"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe a
</span><a href="#local-6989586621680025815"><span class="hs-identifier hs-var">getter</span></a></span></span><span> </span><span id="local-6989586621680025814"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680025814"><span class="hs-identifier hs-var">hash</span></a></span></span><span>
</span><span id="line-1076"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; InvalidBlocks blk -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.member</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680025814"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680025816"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1077"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe a
</span><a href="#local-6989586621680025815"><span class="hs-identifier hs-var">getter</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680025814"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-1078"></span><span>
</span><span id="line-1079"></span><span class="hs-comment">-- | Wrap a @successors@ function so that invalid blocks are not returned as</span><span>
</span><span id="line-1080"></span><span class="hs-comment">-- successors.</span><span>
</span><span id="line-1081"></span><span id="local-6989586621680026671"><span id="local-6989586621680026673"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalidSuc"><span class="hs-identifier hs-type">ignoreInvalidSuc</span></a></span><span>
</span><span id="line-1082"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026673"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1083"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680026671"><span class="hs-identifier hs-type">proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026673"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1084"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlocks"><span class="hs-identifier hs-type">InvalidBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026673"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1085"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026673"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026673"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1086"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026673"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680026673"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1087"></span><span id="ignoreInvalidSuc"><span class="annot"><span class="annottext">ignoreInvalidSuc :: proxy blk
-&gt; InvalidBlocks blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalidSuc"><span class="hs-identifier hs-var hs-var">ignoreInvalidSuc</span></a></span></span><span> </span><span class="annot"><span class="annottext">proxy blk
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680025813"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680025813"><span class="hs-identifier hs-var">invalid</span></a></span></span><span> </span><span id="local-6989586621680025812"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680025812"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1088"></span><span>    </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Bool)
-&gt; Set (HeaderHash blk) -&gt; Set (HeaderHash blk)
forall a. (a -&gt; Bool) -&gt; Set a -&gt; Set a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Set.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk -&gt; InvalidBlocks blk -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-operator hs-var">`Map.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621680025813"><span class="hs-identifier hs-var">invalid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Set (HeaderHash blk) -&gt; Set (HeaderHash blk))
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621680025812"><span class="hs-identifier hs-var">succsOf</span></a></span><span>
</span><span id="line-1089"></span></pre></body></html>